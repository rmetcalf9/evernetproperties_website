import{Q as Z,a as q}from"./QTabs.9b3a146e.js";import{a2 as x,d as B,_ as E,o as i,K as u,g as ee,ax as te,au as oe,k as Y,q as Q,x as L,u as se,a as l,w as d,f as b,t as w,aa as z,ae as j,ai as T,Q as h,e as _,M as R,O as S,ag as I,aj as U,r as $,c as V,ak as ae,L as m,af as re,a9 as le,N as ne}from"./index.1dd362fa.js";import{Q as ie}from"./QPage.ce2ca56b.js";import{u as A}from"./backend_connection.ccda3c90.js";import{u as M}from"./data_caches.0b3bf1a7.js";import{W as k}from"./Workflow_main.512fc34f.js";import{u as D}from"./utils.99aafcb0.js";import{Q as G,a as H}from"./QItemSection.44d04fc6.js";import{Q as de}from"./QList.d37bb4e8.js";import{Q as ce}from"./QPopupProxy.3176f63b.js";import{b as K,Q as _e}from"./QTable.e97de707.js";import{C as F}from"./ClosePopup.5767cfaa.js";import{C as ue}from"./CommonBRRToolLink.441c9c3b.js";import{a as W}from"./QSelect.4af34799.js";import{Q as N}from"./QSpace.bd472c8e.js";import{c as fe,z as ge}from"./zoom.2619b28f.js";import{T as he}from"./TodoDisplay.76935cc7.js";import{f as pe}from"./featureflags.2c595d38.js";import"./QResizeObserver.f803d442.js";import"./axios.6e1fcf85.js";import"./QMenu.274dc854.js";import"./position-engine.ef4a36a4.js";import"./use-fullscreen.e8edf99e.js";import"./QItemLabel.30dac8b7.js";import"./TodoItem.64661e28.js";import"./common_constants.94b43302.js";function me(e){return{purchase:{cumulatively_loaded_stages:{},cumulatively_loaded_sources:{},cumulatively_loaded_agents:{}},rent:{cumulatively_loaded_stages:{},cumulatively_loaded_sources:{},cumulatively_loaded_agents:{}}}}const ke=x("cumulatively_loaded_stages",{state:()=>({value:{}}),getters:{none(e){}},actions:{_createPatchRecordIfRequired(e){Object.keys(this.value).includes(e)||(this.value[e]=me())},findPatchRecord(e){return this._createPatchRecordIfRequired(e),this.value[e]},reportFoundStage({type:e,patch_id:t,workflow_stage_id:s,workflow_id:o,stage_id:r,stage:n,stage_selected:a}){this._createPatchRecordIfRequired(t),s in this.value[t][e].cumulatively_loaded_stages||(this.value[t][e].cumulatively_loaded_stages[s]={workflow_stage_id:s,workflow_id:o,stage_id:r,stage:n,selected:a})},reportFoundProject({type:e,patch_id:t,workflow_stage_id:s,workflow_id:o,stage_id:r,stage:n,stage_selected:a,source:c,source_selected:f,agent:g,agent_selected:p}){this.reportFoundStage({type:e,patch_id:t,workflow_stage_id:s,workflow_id:o,stage_id:r,stage:n,stage_selected:a}),c in this.value[t][e].cumulatively_loaded_sources||(this.value[t][e].cumulatively_loaded_sources[c]={name:c,selected:f}),g in this.value[t][e].cumulatively_loaded_agents||(this.value[t][e].cumulatively_loaded_agents[g]={name:g,selected:p})}}});function ye(e){return e.type==="purchase"?typeof e.sub_section_details.dealbasicinfo.postcode!="undefined"?e.sub_section_details.dealbasicinfo.address+", "+e.sub_section_details.dealbasicinfo.postcode:e.sub_section_details.dealbasicinfo.address:typeof e.sub_section_details.leadinformation.postcode!="undefined"?e.sub_section_details.leadinformation.address+", "+e.sub_section_details.leadinformation.postcode:e.sub_section_details.leadinformation.address}function be(e){return e.type==="purchase"?D.get_source_text(e.sub_section_details.dealbasicinfo.deal_source):e.sub_section_details.leadinformation.lead_source}function ve(e,t){if(e.type==="purchase"){if(typeof e.sub_section_details.dealbasicinfo.selling_agent_id=="undefined")return D.get_agent_text(e.sub_section_details.dealbasicinfo.selling_agent);if(e.sub_section_details.dealbasicinfo.selling_agent_id==="")return D.get_agent_text(e.sub_section_details.dealbasicinfo.selling_agent);const s=t.get_direct_from_cache({object_type:"patchagents",object_id:e.patch_id});return typeof s=="undefined"||typeof s.agents=="undefined"||typeof s.agents[e.sub_section_details.dealbasicinfo.selling_agent_id]=="undefined"?"":s.agents[e.sub_section_details.dealbasicinfo.selling_agent_id].agent_name}return""}function we(e){return e.type==="purchase"?e.sub_section_details.vision.devplan:""}function je(e){return e.type==="purchase"?e.sub_section_details.dealbasicinfo.notes:""}var v={address:ye,dealsource:be,sellingAgent:ve,devplan:we,notes:je};const $e=function(e){return v.dealsource(e)},Ce=function(e,t){return v.sellingAgent(e,t)},Pe=B({name:"ProjectData",setup(){const e=A(),t=ke(),s=M();return{backend_connection_store:e,patch_local_settings_store:t,dataCachesStore:s}},props:["project_type"],data(){return{loaded_projects:[],filtered_loaded_projects:[],project_filter:{filter_stages:!0,selected_stages:[],filter_agents:!0,selected_agents:[],filter_sources:!0,selected_sources:[]},patch_id:void 0,get_cur_filter_fn:void 0,get_source_text_fn:$e,get_agent_text_fn:Ce}},watch:{loaded_projects(e){this.recompute_filtered_projects()}},computed:{cumulatively_loaded_stages:{get(){return this.patch_local_settings_store.findPatchRecord(this.patch_id)[this.project_type].cumulatively_loaded_stages}},cumulatively_loaded_sources:{get(){return this.patch_local_settings_store.findPatchRecord(this.patch_id)[this.project_type].cumulatively_loaded_sources}},cumulatively_loaded_agents:{get(){return this.patch_local_settings_store.findPatchRecord(this.patch_id)[this.project_type].cumulatively_loaded_agents}}},methods:{projecttablefilterchanged(e){typeof e=="undefined"?(this.project_filter.filter_stages=!1,this.project_filter.selected_stages=[],this.project_filter.filter_agents=!1,this.project_filter.selected_agents=[],this.project_filter.filter_sources=!1,this.project_filter.selected_sources=[]):(this.project_filter.filter_stages=!0,this.project_filter.selected_stages=e.selected_stages,this.project_filter.filter_agents=!0,this.project_filter.selected_agents=e.selected_agents,this.project_filter.filter_sources=!0,this.project_filter.selected_sources=e.selected_sources),this.recompute_filtered_projects()},_recompute_filtered_projects_stage_filter(e){if(!this.project_filter.filter_stages)return!0;const t=k.get_workflow_stage_key(e.item.workflow.workflow_used_id,e.item.workflow.current_stage);return!!this.project_filter.selected_stages.includes(t)},_recompute_filtered_projects_agent_filter(e){if(!this.project_filter.filter_agents)return!0;const t=this.get_agent_text_fn(e.item,this.dataCachesStore);return!!this.project_filter.selected_agents.includes(t)},_recompute_filtered_projects_source_filter(e){if(!this.project_filter.filter_sources)return!0;const t=this.get_source_text_fn(e.item);return!!this.project_filter.selected_sources.includes(t)},is_project_included_in_current_filters(e){return this._recompute_filtered_projects_stage_filter(e)?e.loaded?!(!this._recompute_filtered_projects_agent_filter(e)||!this._recompute_filtered_projects_source_filter(e)):!0:!1},recompute_filtered_projects(){const e=this;this.filtered_loaded_projects=this.loaded_projects.filter(function(t){return e.is_project_included_in_current_filters(t)})},refresh({project_info_to_load:e,patch_id:t,get_cur_filter_fn:s}){const o=this;this.get_cur_filter_fn=s,this.patch_id=t,this.loaded_projects=e.map(function(n){const a=k.get_workflow_stage_key(n.workflow_id,n.stage_id);return o.patch_local_settings_store.reportFoundStage({type:o.project_type,patch_id:o.patch_id,workflow_stage_id:a,workflow_id:n.workflow_id,stage_id:n.stage_id,stage:k.getWorkflowStage(n.workflow_id,n.stage_id),stage_selected:D.boolean_undefined_to_false(k.workflows[n.workflow_id].stages[n.stage_id].active)}),{id:n.project_id,loaded:!1,item:{workflow:{workflow_used_id:n.workflow_id,current_stage:n.stage_id}}}});const r={ok:function(n){o.recursive_load_project_details()},error:function(n){console.log("Error when getting agent data for patch")}};o.dataCachesStore.get({backend_connection_store:this.backend_connection_store,object_type:"patchagents",object_id:t,skip_cache:!1,callback:r})},_get_next_item_to_load(){const e=this,t=this.loaded_projects.filter(function(o){return o.loaded?!1:e.is_project_included_in_current_filters(o)});if(t.length!==0)return t[0];const s=this.loaded_projects.filter(function(o){return o.loaded!==!0});if(s.length!==0)return s[0]},recursive_load_project_details(){const e=this._get_next_item_to_load();if(typeof e=="undefined")return;const t=this,s={ok:function(o){e.loaded=!0,e.item=o.data,t.add_to_cumulatively_loaded(o.data),t.projecttablefilterchanged(t.get_cur_filter_fn()),t.recompute_filtered_projects(),t.recursive_load_project_details()},error:function(o){e.loaded=!0,e.address="TODO LOAD FAIL",t.recursive_load_project_details()}};this.dataCachesStore.get({backend_connection_store:this.backend_connection_store,object_type:"projects",object_id:e.id,skip_cache:!1,callback:s})},add_to_cumulatively_loaded(e){const t=k.get_workflow_stage_key(e.workflow.workflow_used_id,e.workflow.current_stage),s=this.get_source_text_fn(e),o=this.get_agent_text_fn(e,this.dataCachesStore);this.patch_local_settings_store.reportFoundProject({type:this.project_type,patch_id:this.patch_id,workflow_stage_id:t,workflow_id:e.workflow.workflow_used_id,stage_id:e.workflow.current_stage,stage:k.getWorkflowStage(e.workflow.workflow_used_id,e.workflow.current_stage),stage_selected:D.boolean_undefined_to_false(k.workflows[e.workflow.workflow_used_id].stages[e.workflow.current_stage].active),source:s,source_selected:!0,agent:o,agent_selected:!0})}}});function Te(e,t,s,o,r,n){return i(),u("div")}var Re=E(Pe,[["render",Te]]),Se=ee({name:"QBanner",props:{...te,inlineActions:Boolean,dense:Boolean,rounded:Boolean},setup(e,{slots:t}){const{proxy:{$q:s}}=se(),o=oe(e,s),r=Y(()=>"q-banner row items-center"+(e.dense===!0?" q-banner--dense":"")+(o.value===!0?" q-banner--dark q-dark":"")+(e.rounded===!0?" rounded-borders":"")),n=Y(()=>`q-banner__actions row items-center justify-end col-${e.inlineActions===!0?"auto":"all"}`);return()=>{const a=[Q("div",{class:"q-banner__avatar col-auto row items-center self-start"},L(t.avatar)),Q("div",{class:"q-banner__content col text-body2"},L(t.default))],c=L(t.action);return c!==void 0&&a.push(Q("div",{class:n.value},c)),Q("div",{class:r.value+(e.inlineActions===!1&&c!==void 0?" q-banner--top-padding":""),role:"alert"},a)}}});const Ve=B({name:"ProjectTableFilterComponent",props:["projects","cumulatively_loaded_stages","cumulatively_loaded_agents","cumulatively_loaded_sources"],emits:["filterchanged"],components:{},setup(){return{backend_connection_store:A()}},data(){return{dialog_stages:!1,dialog_sources:!1,dialog_agents:!1}},computed:{stages(){const e=this;let t=[];return Object.keys(e.cumulatively_loaded_stages).forEach(function(s){t.push(e.cumulatively_loaded_stages[s])}),t},agents(){const e=this;let t=[];return Object.keys(e.cumulatively_loaded_agents).forEach(function(s){t.push(e.cumulatively_loaded_agents[s])}),t},sources(){const e=this;let t=[];return Object.keys(e.cumulatively_loaded_sources).forEach(function(s){t.push(e.cumulatively_loaded_sources[s])}),t},filter_stages_options(){return[{label:"Call Agent",value:"agent"},{label:"Call Sourcer",value:"sourcer"},{label:"Other",value:"other"}]},isStageSelected(e){return!0}},methods:{close_all_dialogs(){this.dialog_stages=!1,this.dialog_agents=!1,this.dialog_sources=!1},click_filter_chip(e){if(this.close_all_dialogs(),e==="Stages"){this.dialog_stages=!0;return}if(e==="Agents"){this.dialog_agents=!0;return}this.dialog_sources=!0},_isFiltered(e){return e.filter(function(s){return!s.selected}).length>0},isFiltered(e){return e==="Stages"?this._isFiltered(this.stages):e==="Sources"?this._isFiltered(this.sources):this._isFiltered(this.agents)},onlyActiveShowing(){let e=!0;return this.stages.forEach(function(t){t.stage.active?t.selected||(e=!1):t.selected&&(e=!1)}),e},filter_text(e){return e==="Stages"&&this.onlyActiveShowing()?"Filter: Active Stages":this.isFiltered(e)?"Filter: "+e:"Filter: "+e+" - not filtered"},set_selected_stages(e){this.stages.forEach(function(t){e.includes(t.workflow_stage_id)?t.selected=!0:t.selected=!1}),this.agents.forEach(function(t){t.selected=!0}),this.sources.forEach(function(t){t.selected=!0}),this.emit_filter_changed_signal()},get_current_filter(){let e=[];this.stages.forEach(function(o){o.selected&&e.push(o.workflow_stage_id)});let t=[];this.agents.forEach(function(o){o.selected&&t.push(o.name)});let s=[];return this.sources.forEach(function(o){o.selected&&s.push(o.name)}),{selected_stages:e,selected_agents:t,selected_sources:s}},emit_filter_changed_signal(){this.$emit("filterchanged",this.get_current_filter())},click_stages_select_none(){this.stages.forEach(function(e){e.selected=!1}),this.emit_filter_changed_signal()},click_stages_select_all(){this.stages.forEach(function(e){e.selected=!0}),this.emit_filter_changed_signal()},click_agents_select_none(){this.agents.forEach(function(e){e.selected=!1}),this.emit_filter_changed_signal()},click_agents_select_all(){this.agents.forEach(function(e){e.selected=!0}),this.emit_filter_changed_signal()},click_sources_select_none(){this.sources.forEach(function(e){e.selected=!1}),this.emit_filter_changed_signal()},click_sources_select_all(){this.sources.forEach(function(e){e.selected=!0}),this.emit_filter_changed_signal()},click_stages_select_active(){this.stages.forEach(function(e){let t=!1;typeof e.stage.active!="undefined"&&(t=e.stage.active),e.selected=t}),this.emit_filter_changed_signal()}},mounted(){}}),Fe=_("div",{class:"text-h6"},"Filter Stages",-1),De={class:"col project_table_filters_any_filter"},Be={class:"row"},Ee={class:"row"},Qe={class:"project_table_filters_any_filter_button"},Ae={class:"project_table_filters_any_filter_button"},qe={class:"project_table_filters_any_filter_button"},Le={class:"project_table_filters_any_filter_button"},ze=_("div",{class:"text-h6"},"Filter Agents",-1),Ie={class:"row project_table_filters_any_filter"},Ue={class:"project_table_filters_any_filter_button"},We={class:"project_table_filters_any_filter_button"},Ne={class:"project_table_filters_any_filter_button"},Oe=_("div",{class:"text-h6"},"Filter Sources",-1),Me={class:"row project_table_filters_any_filter"},Ye={class:"project_table_filters_any_filter_button"},Ge={class:"project_table_filters_any_filter_button"},He={class:"project_table_filters_any_filter_button"};function Ke(e,t,s,o,r,n){return i(),u("div",null,[l(W,{clickable:"",onClick:t[0]||(t[0]=a=>e.click_filter_chip("Stages")),removable:e.isFiltered("Stages"),onRemove:e.click_stages_select_all,color:"primary","text-color":"white","icon-remove":"close"},{default:d(()=>[b(w(e.filter_text("Stages")),1)]),_:1},8,["removable","onRemove"]),l(W,{clickable:"",onClick:t[1]||(t[1]=a=>e.click_filter_chip("Agents")),removable:e.isFiltered("Agents"),onRemove:e.click_agents_select_all,color:"primary","text-color":"white","icon-remove":"close"},{default:d(()=>[b(w(e.filter_text("Agents")),1)]),_:1},8,["removable","onRemove"]),l(W,{clickable:"",onClick:t[2]||(t[2]=a=>e.click_filter_chip("Sources")),removable:e.isFiltered("Sources"),onRemove:e.click_sources_select_all,color:"primary","text-color":"white","icon-remove":"close"},{default:d(()=>[b(w(e.filter_text("Sources")),1)]),_:1},8,["removable","onRemove"]),l(U,{modelValue:e.dialog_stages,"onUpdate:modelValue":t[3]||(t[3]=a=>e.dialog_stages=a)},{default:d(()=>[l(z,{class:"todoitem-dialogcard"},{default:d(()=>[l(j,{class:"row items-center q-pb-none"},{default:d(()=>[Fe,l(N),T(l(h,{icon:"close",flat:"",round:"",dense:""},null,512),[[F]])]),_:1}),l(j,null,{default:d(()=>[_("div",De,[_("div",Be,[(i(!0),u(R,null,S(e.stages,a=>(i(),u("div",{key:a.workflow_stage_id},[l(I,{modelValue:a.selected,"onUpdate:modelValue":c=>a.selected=c,label:a.stage.name,onClick:e.emit_filter_changed_signal},null,8,["modelValue","onUpdate:modelValue","label","onClick"])]))),128))]),_("div",Ee,[_("div",Qe,[l(h,{color:"primary",label:"Select all",onClick:e.click_stages_select_all},null,8,["onClick"])]),_("div",Ae,[l(h,{color:"primary",label:"Select none",onClick:e.click_stages_select_none},null,8,["onClick"])]),_("div",qe,[l(h,{color:"primary",label:"Select active",onClick:e.click_stages_select_active},null,8,["onClick"])]),_("div",Le,[l(h,{color:"secondary",label:"Close",onClick:e.close_all_dialogs},null,8,["onClick"])])])])]),_:1})]),_:1})]),_:1},8,["modelValue"]),l(U,{modelValue:e.dialog_agents,"onUpdate:modelValue":t[4]||(t[4]=a=>e.dialog_agents=a)},{default:d(()=>[l(z,{class:"todoitem-dialogcard"},{default:d(()=>[l(j,{class:"row items-center q-pb-none"},{default:d(()=>[ze,l(N),T(l(h,{icon:"close",flat:"",round:"",dense:""},null,512),[[F]])]),_:1}),l(j,null,{default:d(()=>[_("div",Ie,[(i(!0),u(R,null,S(e.agents,a=>(i(),u("div",{key:a.name},[l(I,{modelValue:a.selected,"onUpdate:modelValue":c=>a.selected=c,label:a.name,onClick:e.emit_filter_changed_signal},null,8,["modelValue","onUpdate:modelValue","label","onClick"])]))),128)),_("div",Ue,[l(h,{color:"primary",label:"Select all",onClick:e.click_agents_select_all},null,8,["onClick"])]),_("div",We,[l(h,{color:"primary",label:"Select none",onClick:e.click_agents_select_none},null,8,["onClick"])]),_("div",Ne,[l(h,{color:"secondary",label:"Close",onClick:e.close_all_dialogs},null,8,["onClick"])])])]),_:1})]),_:1})]),_:1},8,["modelValue"]),l(U,{modelValue:e.dialog_sources,"onUpdate:modelValue":t[5]||(t[5]=a=>e.dialog_sources=a)},{default:d(()=>[l(z,{class:"todoitem-dialogcard"},{default:d(()=>[l(j,{class:"row items-center q-pb-none"},{default:d(()=>[Oe,l(N),T(l(h,{icon:"close",flat:"",round:"",dense:""},null,512),[[F]])]),_:1}),l(j,null,{default:d(()=>[_("div",Me,[(i(!0),u(R,null,S(e.sources,a=>(i(),u("div",{key:a.name},[l(I,{modelValue:a.selected,"onUpdate:modelValue":c=>a.selected=c,label:a.name,onClick:e.emit_filter_changed_signal},null,8,["modelValue","onUpdate:modelValue","label","onClick"])]))),128)),_("div",Ye,[l(h,{color:"primary",label:"Select all",onClick:e.click_sources_select_all},null,8,["onClick"])]),_("div",Ge,[l(h,{color:"primary",label:"Select none",onClick:e.click_sources_select_none},null,8,["onClick"])]),_("div",He,[l(h,{color:"secondary",label:"Close",onClick:e.close_all_dialogs},null,8,["onClick"])])])]),_:1})]),_:1})]),_:1},8,["modelValue"])])}var Xe=E(Ve,[["render",Ke]]);const Je=B({name:"ToolsCansavePatchePage",props:["projects","prefiltered","cumulatively_loaded_stages","cumulatively_loaded_agents","cumulatively_loaded_sources"],emits:["filterchanged","onRowClick","refresh_button"],components:{CommonBRRToolLink:ue,ProjectTableFilters:Xe},setup(){const e=A(),t=M();return{backend_connection_store:e,dataCachesStore:t}},data(){return{filter:"",columns:[{name:"address",required:!0,label:"Address",align:"left",field:"address",sortable:!0},{name:"workflowstage",required:!0,label:"Stage",align:"left",field:"stage",sortable:!0},{name:"visionandnotes",required:!0,label:"Vision and Notes",align:"left",field:"vandnotes",sortable:!1},{name:"source",required:!0,label:"Source",align:"left",field:"source",sortable:!0},{name:"agent",required:!0,label:"Agent",align:"left",field:"selling_agent",sortable:!0},{name:"todo",required:!0,label:"Todos",align:"left",field:"todo",sortable:!1}],initialPagination:{rowsPerPage:50}}},computed:{filter_stages_options(){return[{label:"Call Agent",value:"agent"},{label:"Call Sourcer",value:"sourcer"},{label:"Other",value:"other"}]},user_profile(){return this.backend_connection_store.user_profile},table_content(){const e=this;return this.projects.map(function(t){return t.loaded?{id:t.id,loaded:t.loaded,address:v.address(t.item),source:e.get_source_text(t.item),selling_agent:v.sellingAgent(t.item,e.dataCachesStore),vandnotes:"NOT DISPLAYED",devplan:v.devplan(t.item),notes:v.notes(t.item),stage:e.getWorkflowStage(t.item.workflow).name,todo:e.get_todo_text(t)}:{id:t.id,loaded:!1,address:"Loading...",source:"",selling_agent:"",vandnotes:"",devplan:"",notes:"",stage:e.getWorkflowStage(t.item.workflow).name,todo:""}})}},methods:{get_current_filter(){return this.$refs.ProjectTableFilters.get_current_filter()},set_selected_stages(e){this.$refs.ProjectTableFilters.set_selected_stages(e)},get_todo_text(e){let t=0,s=0,o=0;return typeof e.item.todos!="undefined"&&(t=e.item.todos.filter(function(r){return!r.done&&!r.due}).length,s=e.item.todos.filter(function(r){return!r.done&&r.due}).length,o=e.item.todos.filter(function(r){return r.done}).length),s.toString()+"/"+(t+s).toString()+" ("+o.toString()+")"},get_source_text(e){return v.dealsource(e)},getWorkflowStage({workflow_used_id:e,current_stage:t}){return k.workflows[e].stages[t]}},mounted(){this.$refs.ProjectTableFilters.emit_filter_changed_signal()}}),Ze={class:"projecttablecontainer"},xe={class:"projecttablestyle"},et={class:"row"},tt={class:"col-grow"},ot=_("th",{align:"left"},[b("Todo"),_("br"),b("due/total (done)")],-1),st={key:0},at={key:0},rt={key:1},lt={key:0},nt={key:0},it={key:1},dt={key:1};function ct(e,t,s,o,r,n){const a=$("ProjectTableFilters"),c=$("CommonBRRToolLink");return i(),u("div",Ze,[_("div",xe,[_("div",et,[_("div",tt,[l(a,{ref:"ProjectTableFilters",projects:e.projects,cumulatively_loaded_stages:e.cumulatively_loaded_stages,cumulatively_loaded_agents:e.cumulatively_loaded_agents,cumulatively_loaded_sources:e.cumulatively_loaded_sources,onFilterchanged:t[0]||(t[0]=f=>e.$emit("filterchanged",f))},null,8,["projects","cumulatively_loaded_stages","cumulatively_loaded_agents","cumulatively_loaded_sources"])]),l(h,{icon:"refresh",flat:"",round:"",dense:"",onClick:t[1]||(t[1]=()=>e.$emit("refresh_button"))})]),l(_e,{flat:"",bordered:"",title:"Projects",rows:e.table_content,columns:e.columns,filter:e.filter,pagination:e.initialPagination,"no-data-label":"I didn't find anything for you","no-results-label":"The filter didn't uncover any results","row-key":"name",onRowClick:t[3]||(t[3]=(f,g,p)=>e.$emit("onRowClick",{table_row:g,new_tab:!1}))},{"header-cell-todo":d(()=>[ot]),"body-cell-address":d(f=>[l(K,null,{default:d(()=>[l(ce,{"context-menu":""},{default:d(()=>[l(Se,null,{default:d(()=>[l(de,{style:{"min-width":"100px"}},{default:d(()=>[T((i(),V(H,{clickable:"",onClick:()=>e.$emit("onRowClick",{table_row:f.row,new_tab:!0})},{default:d(()=>[l(G,null,{default:d(()=>[b("Open in new tab...")]),_:1})]),_:2},1032,["onClick"])),[[F]]),l(ae),T((i(),V(H,{clickable:""},{default:d(()=>[l(G,null,{default:d(()=>[b("Cancel")]),_:1})]),_:1})),[[F]])]),_:2},1024)]),_:2},1024)]),_:2},1024),b(" "+w(f.row.address),1)]),_:2},1024)]),"body-cell-visionandnotes":d(f=>[l(K,null,{default:d(()=>[f.row.loaded?(i(),u("div",st,[typeof f.row.devplan!="undefined"?(i(),u("div",at,[(i(!0),u(R,null,S(f.row.devplan.split(`
`),g=>(i(),u("div",{key:g,class:"projecttablehead"},w(g),1))),128))])):m("",!0),typeof f.row.notes!="undefined"?(i(),u("div",rt,[(i(!0),u(R,null,S(f.row.notes.split(`
`),g=>(i(),u("div",{key:g},w(g),1))),128))])):m("",!0)])):m("",!0)]),_:2},1024)]),"top-right":d(()=>[l(re,{borderless:"",dense:"",debounce:"300",modelValue:e.filter,"onUpdate:modelValue":t[2]||(t[2]=f=>e.filter=f),clearable:"",placeholder:"Search"},{append:d(()=>[l(le,{name:"search"})]),_:1},8,["modelValue"])]),"no-data":d(({})=>[e.prefiltered?m("",!0):(i(),u("div",lt,[e.projects.length===0?(i(),u("div",nt,[b(" No projects in this patch - use the BRR calculator to create one "),l(c)])):m("",!0),e.projects.length!==0?(i(),u("div",it," No projects match the filter ")):m("",!0)])),e.prefiltered?(i(),u("div",dt," No projects match the filter ")):m("",!0)]),_:1},8,["rows","columns","filter","pagination"])])])}var _t=E(Je,[["render",ct]]);const C=130,P=400,ut=50;function ft(e,t){let s=[];return Object.keys(e.stages).forEach(function(o){if(o!==t){const r=e.stages[o];typeof r.progression!="undefined"&&(typeof r.progression.failed!="undefined"&&r.progression.failed===t&&s.push(o),typeof r.progression.success!="undefined"&&r.progression.success.forEach(function(n){n.next_stage===t&&s.push(o)}))}}),[...new Set(s)]}function gt(e){let t={};return Object.keys(e.stages).forEach(function(s){e.stages[s],t[s]=ft(e,s)}),t}function ht(e,t,s,o){const r={items_drawn:{},cols:[-300,120,560],incomming_stage_map:gt(t)},n=e.append("g"),a=e.append("g");O(a,t.initial_stage,t.stages[t.initial_stage],r,t,200,!1,s,o),pt(n,t,r)}function pt(e,t,s){Object.keys(t.stages).forEach(function(o){const r=t.stages[o];if(typeof r.active!="undefined"&&r.active&&typeof r.progression!="undefined"&&typeof r.progression.failed!="undefined"){t.stages[r.progression.failed];const n=s.items_drawn[o],a=s.items_drawn[r.progression.failed];X(e,n.pos_x,n.pos_y+C,a.pos_x-P/2,a.pos_y+C/2)}})}function mt(e,t,s){let o=0;return s?o=2:typeof e.draw_col!="undefined"&&(o=e.draw_col),t.cols[o]}function kt(e,t){let s=!0;return t.incomming_stage_map[e].forEach(function(o){typeof t.items_drawn[o]=="undefined"&&(s=!1)}),s}function O(e,t,s,o,r,n,a,c,f){if(Object.keys(o.items_drawn).includes(t))return;const g=mt(s,o,a),p=e.append("g").attr("transform","translate( "+g+" "+n+")");o.items_drawn[t]={pos_x:g,pos_y:n},bt(p,t,s,a,c,r,f),typeof s.progression!="undefined"&&(typeof s.progression.failed!="undefined"&&kt(t,o)&&O(e,s.progression.failed,r.stages[s.progression.failed],o,r,n+150,!0,c,f),typeof s.progression.success!="undefined"&&s.progression.success.forEach(function(y){O(e,y.next_stage,r.stages[y.next_stage],o,r,n+300,!1,c,f),n<o.items_drawn[y.next_stage].pos_y?X(e,g,n+C,o.items_drawn[y.next_stage].pos_x,o.items_drawn[y.next_stage].pos_y):yt(e,g+P/2,n+C/2,o.items_drawn[y.next_stage].pos_x+P/2,o.items_drawn[y.next_stage].pos_y+C/2,ut)}))}function X(e,t,s,o,r){e.append("line").attr("x1",t).attr("y1",s).attr("x2",o).attr("y2",r).attr("stroke","black").attr("style","stroke-width:10;").attr("marker-end","url(#triangle)")}function yt(e,t,s,o,r,n){let a=o;t>o&&(a=t),a+=n,e.append("line").attr("x1",t).attr("y1",s).attr("x2",a).attr("y2",s).attr("stroke","black").attr("style","stroke-width:10;"),e.append("line").attr("x1",a).attr("y1",s).attr("x2",a).attr("y2",r).attr("stroke","black").attr("style","stroke-width:10;"),e.append("line").attr("x1",a).attr("y1",r).attr("x2",o).attr("y2",r).attr("stroke","black").attr("style","stroke-width:10;").attr("marker-end","url(#triangle)")}function bt(e,t,s,o,r,n,a){const c=e.append("g");let f="lightgreen";o&&(f="pink");function g(){r(t,s)}let p=0;if(typeof a.workflow_lookup!="undefined"&&typeof a.workflow_lookup[n.id]!="undefined"&&typeof a.workflow_lookup[n.id][t]!="undefined"&&(p=a.workflow_lookup[n.id][t].length),c.append("rect").attr("width",P).attr("height",C).attr("x",-(P/2)).attr("y",0).attr("style","fill: "+f+";stroke-width:3;stroke:rgb(0,0,0)").on("click",g),c.append("text").attr("x",0).attr("y",50).attr("text-anchor","middle").style("font-size","28px").style("font-weight","500").text(s.name).on("click",g),c.append("text").attr("x",0).attr("y",110).attr("text-anchor","middle").style("font-size","56px").style("font-weight","500").text(p.toString()).on("click",g),typeof s.diagram_notes!="undefined"){let y=0;s.diagram_notes.split("<BR>").forEach(function(J){c.append("text").attr("x",-(P/2+20)).attr("y",y).attr("text-anchor","end").attr("alignment-baseline","text-before-edge").style("font-size","24px").style("font-weight","500").text(J),y=y+30})}}const vt=B({name:"WorkflowChart",props:["patch_data","workflow_id"],emits:["onclickstage"],data(){return{allzoomedelements:void 0,boudaryRect:void 0,svg:void 0,background_item_group:void 0,chartarea:{xmin:-950,xmax:950,ymin:-150,ymax:2500}}},computed:{workflow(){return k.workflows[this.workflow_id]}},methods:{initChart(){for(var e=this,t=function(o){var r=800,n=800;o.svg=fe("svg").attr("style","border: 1px solid black;position:fixed; top:0; left:0; height:100%; width:100%").attr("viewBox",[-r/2,-n/2,r,n]).attr("oncontextmenu","return false;"),o.allzoomedelements=o.svg.append("g"),e.boudaryRect=o.allzoomedelements.append("rect").attr("width",o.chartarea.xmax-o.chartarea.xmin).attr("height",o.chartarea.ymax-o.chartarea.ymin).attr("x",o.chartarea.xmin).attr("y",o.chartarea.ymin).attr("style","fill: white;stroke-width:3;stroke:rgb(0,0,0)"),o.svg.call(ge().extent([[0,0],[r,n]]).scaleExtent([-5,10]).on("zoom",a)),o.svg.on("dblclick.zoom",null);function a(c,f){o.allzoomedelements.attr("transform",c.transform)}return o.allzoomedelements.append("text").attr("text-anchor","middle").attr("alignment-baseline","central").attr("x",0).attr("y",-70).attr("style","font-size: 60px; font-weight: 800;").text(c=>e.workflow.name),o.allzoomedelements.append("text").attr("text-anchor","middle").attr("alignment-baseline","central").attr("x",0).attr("y",-0).attr("style","font-size: 50px; font-weight: 300;").text(c=>"Projects for patch "+e.patch_data.name),o.svg.node()},s=document.getElementById("chartInsetionPoint_workflowchart");s.firstChild;)console.log("Removing old SVG"),s.removeChild(s.firstChild);s.appendChild(t(this)),this.svg.append("marker").attr("id","triangle").attr("viewBox","0 0 10 10").attr("refX","8").attr("refY","5").attr("markerUnits","strokeWidth").attr("markerWidth","4").attr("markerHeight","4").attr("orient","auto").attr("fill","black").append("path").attr("d","M 0 0 L 10 5 L 0 10 z"),ht(this.allzoomedelements,this.workflow,this.click_stage_callback,this.patch_data)},click_stage_callback(e,t){this.$emit("onclickstage",this.workflow.id,e,t)},clickDIV(){}},mounted(){this.initChart()}});function wt(e,t,s,o,r,n){return i(),u("div",{id:"chartInsetionPoint_workflowchart",onClick:t[0]||(t[0]=a=>e.clickDIV(a))})}var jt=E(vt,[["render",wt]]);const $t=B({name:"ToolsCansavePatchePage",components:{ProjectTable:_t,WrokflowChart:jt,TodoDisplay:he,ProjectData:Re},setup(){const e=A(),t=M();return{backend_connection_store:e,dataCachesStore:t}},data(){return{loaded:!1,patch_data:{},tab:"projects",workflow_id:k.default_workflow_id,workflow_return_type:void 0}},computed:{featureflags(){return pe},buy_filtered_loaded_projects(){return this.$refs.BuyProjectData.filtered_loaded_projects},buy_cumulatively_loaded_stages(){return this.$refs.BuyProjectData.cumulatively_loaded_stages},buy_cumulatively_loaded_sources(){return this.$refs.BuyProjectData.cumulatively_loaded_sources},buy_cumulatively_loaded_agents(){return this.$refs.BuyProjectData.cumulatively_loaded_agents},rent_filtered_loaded_projects(){return this.$refs.RentProjectData.filtered_loaded_projects},rent_cumulatively_loaded_stages(){return this.$refs.RentProjectData.cumulatively_loaded_stages},rent_cumulatively_loaded_sources(){return this.$refs.RentProjectData.cumulatively_loaded_sources},rent_cumulatively_loaded_agents(){return this.$refs.RentProjectData.cumulatively_loaded_agents},selectedStageText(){return k.workflows[this.selected_stage.workflow_id].stages[this.selected_stage.stage_id].name},user_profile(){return this.backend_connection_store.user_profile}},methods:{refresh_button(e){this.dataCachesStore.reset(),this.refresh()},buy_onRowClick({table_row:e,new_tab:t}){if(t){const s=this.$router.resolve("/tools/brrcalc"),o=new URL(s.href,window.location.origin+window.location.pathname).href+"?projectid="+e.id;window.open(o),window.focus();return}this.$router.push("/tools/brrcalc?projectid="+e.id)},rent_onRowClick({table_row:e,new_tab:t}){if(t){const s=this.$router.resolve("/tools/rentproject/rentcalc"),o=new URL(s.href,window.location.origin+window.location.pathname).href+"?projectid="+e.id;window.open(o),window.focus();return}this.$router.push("/tools/rentproject/rentcalc?projectid="+e.id)},btn_click_workflow(e){e==="rent"?this.workflow_id=k.default_rent_workflow_id:this.workflow_id=k.default_workflow_id,this.workflow_return_type=e,this.tab="workflow"},buy_projecttablefilterchanged(e){this.$refs.BuyProjectData.projecttablefilterchanged(e)},rent_projecttablefilterchanged(e){this.$refs.RentProjectData.projecttablefilterchanged(e)},onchartclickstage(e,t,s){const o=this;if(this.workflow_return_type==="rent"){this.tab="rent_projects",setTimeout(function(){const r=k.get_workflow_stage_key(e,t);o.$refs.RentProjectTableRef.set_selected_stages([r])},5);return}this.tab="projects",setTimeout(function(){const r=k.get_workflow_stage_key(e,t);o.$refs.BuyProjectTableRef.set_selected_stages([r])},5)},clicknewproject(){this.$router.push("/tools/brrcalc?patchid="+this.$route.params.patchid)},clickpatchagentnotes(){this.$router.push("/tools/agents/"+this.$route.params.patchid)},click_brrr_card(){this.$router.push("/tools/brrcalc")},refresh(){const e=this,t={ok:e.refresh_success,error:function(s){ne.create({color:"negative",message:"Failed to find patch information",timeout:2e3}),e.$router.push("/tools/cansave/patches")}};this.dataCachesStore.get({backend_connection_store:this.backend_connection_store,object_type:"patches",object_id:e.$route.params.patchid,skip_cache:!1,callback:t})},get_buy_current_project_filter(){if(typeof this.$refs.BuyProjectTableRef!="undefined"&&this.$refs.BuyProjectTableRef!==null)return this.$refs.BuyProjectTableRef.get_current_filter()},get_rent_current_project_filter(){if(typeof this.$refs.RentProjectTableRef!="undefined"&&this.$refs.RentProjectTableRef!==null)return this.$refs.RentProjectTableRef.get_current_filter()},refresh_success(e){const t=this;t.patch_data=e.data;var s=[],o=[];Object.keys(t.patch_data.workflow_lookup).map(function(r){Object.keys(t.patch_data.workflow_lookup[r]).map(function(n){t.patch_data.workflow_lookup[r][n].map(function(a){(function(f){return typeof t.patch_data.typed_projects.rent=="undefined"?!1:t.patch_data.typed_projects.rent.includes(f)})(a)?o.push({workflow_id:r,stage_id:n,project_id:a}):s.push({workflow_id:r,stage_id:n,project_id:a})})})}),this.$refs.BuyProjectData.refresh({project_info_to_load:s,patch_id:this.patch_data.id,get_cur_filter_fn:this.get_buy_current_project_filter}),this.$refs.RentProjectData.refresh({project_info_to_load:o,patch_id:this.patch_data.id,get_cur_filter_fn:this.get_rent_current_project_filter}),this.loaded=!0}},mounted(){this.loaded=!1,typeof this.$route.query.starttab!="undefined"&&(this.tab=this.$route.query.starttab),this.refresh()}}),Ct={key:0},Pt=_("h1",null,"Loading...",-1),Tt=[Pt],Rt={key:1},St={key:0},Vt={key:2},Ft={class:"patch-button-bar"},Dt={key:3},Bt={class:"patch-button-bar"},Et={key:4},Qt={key:5};function At(e,t,s,o,r,n){const a=$("ProjectTable"),c=$("TodoDisplay"),f=$("WrokflowChart"),g=$("ProjectData");return i(),V(ie,{class:"patchpageclass"},{default:d(()=>[e.loaded?m("",!0):(i(),u("div",Ct,Tt)),e.loaded?(i(),u("div",Rt,[e.tab!=="workflow"?(i(),u("h1",St,w(e.patch_data.name),1)):m("",!0),e.tab!=="workflow"?(i(),V(Z,{key:1,modelValue:e.tab,"onUpdate:modelValue":t[0]||(t[0]=p=>e.tab=p),dense:"",class:"text-grey","active-color":"primary","indicator-color":"primary",align:"justify","narrow-indicator":""},{default:d(()=>[l(q,{name:"projects",label:"Buy Projects"}),e.featureflags.rent_to_rent_projects?(i(),V(q,{key:0,name:"rent_projects",label:"Rent Projects"})):m("",!0),l(q,{name:"todos",label:"Todos"})]),_:1},8,["modelValue"])):m("",!0),e.tab==="projects"?(i(),u("div",Vt,[_("h2",null,[b(" Buy Projects "),l(h,{label:"Pick from workflow",color:"primary",onClick:t[1]||(t[1]=p=>e.btn_click_workflow("purchase")),class:"float-right"})]),_("div",null,[l(a,{ref:"BuyProjectTableRef",projects:e.buy_filtered_loaded_projects,prefiltered:!0,cumulatively_loaded_stages:e.buy_cumulatively_loaded_stages,cumulatively_loaded_agents:e.buy_cumulatively_loaded_agents,cumulatively_loaded_sources:e.buy_cumulatively_loaded_sources,onFilterchanged:e.buy_projecttablefilterchanged,onOnRowClick:e.buy_onRowClick,onRefresh_button:t[2]||(t[2]=p=>e.refresh_button("purchase"))},null,8,["projects","cumulatively_loaded_stages","cumulatively_loaded_agents","cumulatively_loaded_sources","onFilterchanged","onOnRowClick"])]),_("div",Ft,[l(h,{color:"primary",label:"Add Project",icon:"add",onClick:e.clicknewproject},null,8,["onClick"]),l(h,{color:"primary",label:"Patch Agent Notes",icon:"edit",onClick:e.clickpatchagentnotes},null,8,["onClick"])])])):m("",!0),e.tab==="rent_projects"?(i(),u("div",Dt,[_("h2",null,[b(" Rent Projects "),l(h,{label:"Pick from workflow",color:"primary",onClick:t[3]||(t[3]=p=>e.btn_click_workflow("rent")),class:"float-right"})]),_("div",null,[l(a,{ref:"RentProjectTableRef",projects:e.rent_filtered_loaded_projects,prefiltered:!0,cumulatively_loaded_stages:e.rent_cumulatively_loaded_stages,cumulatively_loaded_agents:e.rent_cumulatively_loaded_agents,cumulatively_loaded_sources:e.rent_cumulatively_loaded_sources,onFilterchanged:e.rent_projecttablefilterchanged,onOnRowClick:e.rent_onRowClick,onRefresh_button:t[4]||(t[4]=p=>e.refresh_button("rent"))},null,8,["projects","cumulatively_loaded_stages","cumulatively_loaded_agents","cumulatively_loaded_sources","onFilterchanged","onOnRowClick"]),_("div",Bt,[l(h,{color:"primary",label:"Add Lead",onClick:t[5]||(t[5]=p=>e.$router.push("/tools/rentproject/enterlead?defaultpatch="+e.patch_data.id))}),l(h,{color:"primary",label:"Call Leads",onClick:t[6]||(t[6]=p=>e.$router.push("/tools/rentproject/batchcallleads?patchid="+e.patch_data.id))}),l(h,{color:"primary",label:"Show Viewings",onClick:t[7]||(t[7]=p=>e.$router.push("/tools/rentproject/showviewingsforpatch?patchid="+e.patch_data.id))})])])])):m("",!0),e.tab==="todos"?(i(),u("div",Et,[l(c,{patch_id:e.patch_data.id},null,8,["patch_id"])])):m("",!0),e.tab==="workflow"?(i(),u("div",Qt,[l(f,{patch_data:e.patch_data,workflow_id:e.workflow_id,onOnclickstage:e.onchartclickstage},null,8,["patch_data","workflow_id","onOnclickstage"])])):m("",!0)])):m("",!0),l(g,{ref:"BuyProjectData",project_type:"purchase"},null,512),l(g,{ref:"RentProjectData",project_type:"rent"},null,512)]),_:1})}var co=E($t,[["render",At]]);export{co as default};
