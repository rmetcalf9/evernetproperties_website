import{_ as k,d as b,o as n,c as j,w as T,e as a,t as d,a as h,Q as m,K as r,L as u,M as w,O as g}from"./index.3614404b.js";import{Q as $}from"./QPage.0db48769.js";import{u as L}from"./backend_connection.a1a8f07b.js";import{D as v}from"./datetime.5361efaf.js";import"./index.865826ad.js";import{u as P}from"./utils.99aafcb0.js";import"./axios.6e1fcf85.js";const c="2",f="2",y="3",V=b({name:"ShowViewingsForPatchPage",setup(){return{backend_connection_store:L()}},data(){return{projects_fully_loaded:!1,patches_to_scan:[],project_ids_to_load:[],days:[],projects_by_day:{}}},computed:{heading(){const e=this;if(this.$route.query.patchid==="all")return"Viewings for Rental Leads For All patches";if(typeof this.user_profile.patches=="undefined")return"Viewings for Rental Leads";const t=this.user_profile.patches.filter(function(s){return s.id===e.$route.query.patchid});return t.length!==1?"Viewings for Rental Leads":"Viewings for Rental Leads For "+t[0].name},user_profile(){return this.backend_connection_store.user_profile}},methods:{calendar_description(e){return P.rentalprojectcalendardescription({projectid:e.id,leadinformation:e.sub_section_details.leadinformation,call_notes:e.sub_section_details.viewinginformation.call_notes})},display_string_for_day(e){return v.fromISO(e).toFormat("cccc d LLL yyyy")},load_project(e){if(typeof e.sub_section_details.viewinginformation=="undefined"){console.log("Warning - project with no viewing information - skipping");return}if(typeof e.sub_section_details.viewinginformation.viewing_timestamp=="undefined"){console.log("Warning - project with no viewing_timestamp information - skipping");return}const t=e.sub_section_details.viewinginformation.viewing_timestamp.substring(0,10);this.days.includes(t)||(this.days.push(t),this.days=this.days.sort(),this.projects_by_day[t]=[]);const s=v.fromISO(e.sub_section_details.viewinginformation.viewing_timestamp),i=s.plus({hours:1});this.projects_by_day[t].push({raw:e,calc:{viewing_timestamp_js_td:s,time_str:s.toFormat("h:mm a"),is_need_to_prepare:e.workflow.current_stage===f,event_cal_start_date:t,event_cal_end_date:t,event_cal_start_time:s.toFormat("HH:mm"),event_cal_end_time:i.toFormat("HH:mm")}}),this.projects_by_day[t].sort(function(_,p){return _<p?-1:_===p?0:1})},recursive_get_list_of_projects_to_load(){const e=this;if(this.patches_to_scan.length===0){e.recursive_load_projects();return}const t=this.patches_to_scan.pop(),s={ok:function(i){typeof i.data.workflow_lookup[c]!="undefined"&&(typeof i.data.workflow_lookup[c][f]!="undefined"&&i.data.workflow_lookup[c][f].map(function(_){e.project_ids_to_load.push(_)}),typeof i.data.workflow_lookup[c][y]!="undefined"&&i.data.workflow_lookup[c][y].map(function(_){e.project_ids_to_load.push(_)})),e.recursive_get_list_of_projects_to_load()},error:function(i){Notify.create({color:"negative",message:"Unable to load leads (patches) - please try again later",timeout:2e3})}};this.backend_connection_store.call_api({apiprefix:"privateUserAPIPrefix",url:"/patches/"+t,method:"GET",data:void 0,callback:s})},recursive_load_projects(){const e=this;if(this.project_ids_to_load.length===0){e.projects_fully_loaded=!0;return}const t=this.project_ids_to_load.pop(),s={ok:function(i){e.load_project(i.data),e.recursive_load_projects()},error:function(i){Notify.create({color:"negative",message:"Unable to load leads (project) - please try again later",timeout:2e3})}};this.backend_connection_store.call_api({apiprefix:"privateUserAPIPrefix",url:"/projects/"+t,method:"GET",data:void 0,callback:s})}},mounted(){const e=this;e.projects_fully_loaded=!1,e.patches_to_scan=[],e.project_ids_to_load=[],e.days=[],e.projects_by_day={},setTimeout(function(){e.$route.query.patchid==="all"?e.patches_data=e.user_profile.patches.map(function(t){e.patches_to_scan.push(t.id)}):e.patches_to_scan.push(e.$route.query.patchid),e.recursive_get_list_of_projects_to_load()},300)}}),F={class:"fit column wrap justify-start items-start content-center showviewingsforpatch-maindiv"},C={class:"showviewingsforpatch-headingdiv"},D={key:0},N=a("div",null,"Loading...",-1),B=[N],q={key:1},H={key:0,class:"showviewingsforpatch-dayheading"},S={class:"showviewingsforpatch-dayheading"},A={class:"row"},E={class:"showviewingsforpatch-projecttime"},I={key:0},O=["name","location","description","startDate","endDate","startTime","endTime"],Q=a("hr",null,null,-1);function R(e,t,s,i,_,p){return n(),j($,{class:"flex flex-center"},{default:T(()=>[a("div",F,[a("div",C,[a("h2",null,d(e.heading),1),h(m,{label:"Patch",onClick:t[0]||(t[0]=l=>e.$router.push("/tools/cansave/patches/"+e.$route.query.patchid+"?starttab=rent_projects"))})]),e.projects_fully_loaded?u("",!0):(n(),r("div",D,B)),e.projects_fully_loaded?(n(),r("div",q,[e.days.length===0?(n(),r("div",H," No viewings for this patch ")):u("",!0),(n(!0),r(w,null,g(e.days,l=>(n(),r("div",{key:l},[a("div",S,d(e.display_string_for_day(l)),1),(n(!0),r(w,null,g(e.projects_by_day[l],o=>(n(),r("div",{key:o.id,class:"showviewingsforpatch-project"},[a("div",A,[a("div",E,d(o.calc.time_str),1),a("div",null,": "+d(o.raw.sub_section_details.leadinformation.address)+", "+d(o.raw.sub_section_details.leadinformation.postcode),1),o.calc.is_need_to_prepare?(n(),r("div",I,"\xA0(Need to prepare)")):u("",!0),a("div",null,[h(m,{round:"",dense:"",flat:"",color:"primary",icon:"info",onClick:U=>e.$router.push("/tools/rentproject/rentcalc?projectid="+o.raw.id)},null,8,["onClick"])])]),a("div",null,[a("add-to-calendar-button",{name:"Viewing: "+o.raw.sub_section_details.leadinformation.address+", "+o.raw.sub_section_details.leadinformation.postcode,options:"'Apple','Google','Yahoo','iCal'",location:o.raw.sub_section_details.leadinformation.address+", "+o.raw.sub_section_details.leadinformation.postcode,description:e.calendar_description(o.raw),startDate:o.calc.event_cal_start_date,endDate:o.calc.event_cal_end_date,startTime:o.calc.event_cal_start_time,endTime:o.calc.event_cal_end_time,timeZone:"Europe/London"},null,8,O),Q])]))),128))]))),128))])):u("",!0)])]),_:1})}var z=k(V,[["render",R]]);export{z as default};
