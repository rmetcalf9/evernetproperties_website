import{Q as oe,a as Y}from"./QTabs.ccce6e69.js";import{a2 as se,g as Z,ak as ae,al as re,k as q,q as j,x as D,u as ee,j as L,m as ie,bb as ne,aw as R,d as z,_ as x,o as d,K as f,a as s,w as n,f as v,t as C,aa as U,ah as T,ao as $,Q as m,e as _,M as V,O as F,au as N,r as P,c as A,an as ce,L as k,ag as de,a9 as ue,N as _e}from"./index.9626567c.js";import{Q as fe}from"./QPage.d7d4bfcb.js";import{u as H}from"./backend_connection.aeaa5529.js";import{b as K,Q as O}from"./QItemLabel.f48bc29e.js";import{b as X,c as ge,Q as he}from"./QTable.90d31273.js";import{e as me,a as W}from"./QSelect.84cfe662.js";import{u as pe,c as ke}from"./position-engine.86174912.js";import{C as S}from"./ClosePopup.4b19428e.js";import{C as ve}from"./CommonBRRToolLink.7befc57f.js";import{Q as M}from"./TodoItem.af4bcb00.js";import{W as y}from"./Workflow_main.64586049.js";import{u as w}from"./utils.b53f77d9.js";import{c as be,z as ye}from"./zoom.2619b28f.js";import{T as we}from"./TodoDisplay.e81aa4c2.js";import"./QResizeObserver.7a51cc62.js";import"./axios.6e1fcf85.js";function Ce(e){return{cumulatively_loaded_stages:{},cumulatively_loaded_sources:{},cumulatively_loaded_agents:{}}}const Te=se("cumulatively_loaded_stages",{state:()=>({value:{}}),getters:{none(e){console.log("SSS")}},actions:{_createPatchRecordIfRequired(e){Object.keys(this.value).includes(e)||(this.value[e]=Ce())},findPatchRecord(e){return this._createPatchRecordIfRequired(e),this.value[e]},reportFoundProject({patch_id:e,workflow_stage_id:t,workflow_id:o,stage_id:l,stage:r,stage_selected:u,source:a,source_selected:i,agent:c,agent_selected:g}){this._createPatchRecordIfRequired(e),t in this.value[e].cumulatively_loaded_stages||(this.value[e].cumulatively_loaded_stages[t]={workflow_stage_id:t,workflow_id:o,stage_id:l,stage:r,selected:u}),a in this.value[e].cumulatively_loaded_sources||(this.value[e].cumulatively_loaded_sources[a]={name:a,selected:i}),c in this.value[e].cumulatively_loaded_agents||(this.value[e].cumulatively_loaded_agents[c]={name:c,selected:g})}}});var je=Z({name:"QBanner",props:{...ae,inlineActions:Boolean,dense:Boolean,rounded:Boolean},setup(e,{slots:t}){const{proxy:{$q:o}}=ee(),l=re(e,o),r=q(()=>"q-banner row items-center"+(e.dense===!0?" q-banner--dense":"")+(l.value===!0?" q-banner--dark q-dark":"")+(e.rounded===!0?" rounded-borders":"")),u=q(()=>`q-banner__actions row items-center justify-end col-${e.inlineActions===!0?"auto":"all"}`);return()=>{const a=[j("div",{class:"q-banner__avatar col-auto row items-center self-start"},D(t.avatar)),j("div",{class:"q-banner__content col text-body2"},D(t.default))],i=D(t.action);return i!==void 0&&a.push(j("div",{class:u.value},i)),j("div",{class:r.value+(e.inlineActions===!1&&i!==void 0?" q-banner--top-padding":""),role:"alert"},a)}}}),$e=Z({name:"QPopupProxy",props:{...pe,breakpoint:{type:[String,Number],default:450}},emits:["show","hide"],setup(e,{slots:t,emit:o,attrs:l}){const{proxy:r}=ee(),{$q:u}=r,a=L(!1),i=L(null),c=q(()=>parseInt(e.breakpoint,10)),{canShow:g}=ke({showing:a});function b(){return u.screen.width<c.value||u.screen.height<c.value?"dialog":"menu"}const p=L(b()),B=q(()=>p.value==="menu"?{maxHeight:"99vh"}:{});ie(()=>b(),h=>{a.value!==!0&&(p.value=h)});function te(h){a.value=!0,o("show",h)}function le(h){a.value=!1,p.value=b(),o("hide",h)}return Object.assign(r,{show(h){g(h)===!0&&i.value.show(h)},hide(h){i.value.hide(h)},toggle(h){i.value.toggle(h)}}),ne(r,"currentComponent",()=>({type:p.value,ref:i.value})),()=>{const h={ref:i,...B.value,...l,onShow:te,onHide:le};let I;return p.value==="dialog"?I=R:(I=me,Object.assign(h,{target:e.target,contextMenu:e.contextMenu,noParentEvent:!0,separateClosePopup:!0})),j(I,h,t.default)}}});const Pe=z({name:"ProjectTableFilterComponent",props:["projects","cumulatively_loaded_stages","cumulatively_loaded_agents","cumulatively_loaded_sources"],emits:["filterchanged"],components:{},setup(){return{backend_connection_store:H()}},data(){return{dialog_stages:!1,dialog_sources:!1,dialog_agents:!1}},computed:{stages(){const e=this;let t=[];return Object.keys(e.cumulatively_loaded_stages).forEach(function(o){t.push(e.cumulatively_loaded_stages[o])}),t},agents(){const e=this;let t=[];return Object.keys(e.cumulatively_loaded_agents).forEach(function(o){t.push(e.cumulatively_loaded_agents[o])}),t},sources(){const e=this;let t=[];return Object.keys(e.cumulatively_loaded_sources).forEach(function(o){t.push(e.cumulatively_loaded_sources[o])}),t},filter_stages_options(){return[{label:"Call Agent",value:"agent"},{label:"Call Sourcer",value:"sourcer"},{label:"Other",value:"other"}]},isStageSelected(e){return!0}},methods:{close_all_dialogs(){this.dialog_stages=!1,this.dialog_agents=!1,this.dialog_sources=!1},click_filter_chip(e){if(this.close_all_dialogs(),e==="Stages"){this.dialog_stages=!0;return}if(e==="Agents"){this.dialog_agents=!0;return}this.dialog_sources=!0},_isFiltered(e){return e.filter(function(o){return!o.selected}).length>0},isFiltered(e){return e==="Stages"?this._isFiltered(this.stages):e==="Sources"?this._isFiltered(this.sources):this._isFiltered(this.agents)},onlyActiveShowing(){let e=!0;return this.stages.forEach(function(t){t.stage.active?t.selected||(e=!1):t.selected&&(e=!1)}),e},filter_text(e){return e==="Stages"&&this.onlyActiveShowing()?"Filter: Active Stages":this.isFiltered(e)?"Filter: "+e:"Filter: "+e+" - not filtered"},set_selected_stages(e){this.stages.forEach(function(t){e.includes(t.workflow_stage_id)?t.selected=!0:t.selected=!1}),this.agents.forEach(function(t){t.selected=!0}),this.sources.forEach(function(t){t.selected=!0}),this.emit_filter_changed_signal()},get_current_filter(){let e=[];this.stages.forEach(function(l){l.selected&&e.push(l.workflow_stage_id)});let t=[];this.agents.forEach(function(l){l.selected&&t.push(l.name)});let o=[];return this.sources.forEach(function(l){l.selected&&o.push(l.name)}),{selected_stages:e,selected_agents:t,selected_sources:o}},emit_filter_changed_signal(){this.$emit("filterchanged",this.get_current_filter())},click_stages_select_none(){this.stages.forEach(function(e){e.selected=!1}),this.emit_filter_changed_signal()},click_stages_select_all(){this.stages.forEach(function(e){e.selected=!0}),this.emit_filter_changed_signal()},click_agents_select_none(){this.agents.forEach(function(e){e.selected=!1}),this.emit_filter_changed_signal()},click_agents_select_all(){this.agents.forEach(function(e){e.selected=!0}),this.emit_filter_changed_signal()},click_sources_select_none(){this.sources.forEach(function(e){e.selected=!1}),this.emit_filter_changed_signal()},click_sources_select_all(){this.sources.forEach(function(e){e.selected=!0}),this.emit_filter_changed_signal()},click_stages_select_active(){this.stages.forEach(function(e){let t=!1;typeof e.stage.active!="undefined"&&(t=e.stage.active),e.selected=t}),this.emit_filter_changed_signal()}},mounted(){}}),Se=_("div",{class:"text-h6"},"Filter Stages",-1),Re={class:"col project_table_filters_any_filter"},Ve={class:"row"},Fe={class:"row"},Qe={class:"project_table_filters_any_filter_button"},Ee={class:"project_table_filters_any_filter_button"},qe={class:"project_table_filters_any_filter_button"},Ae={class:"project_table_filters_any_filter_button"},ze=_("div",{class:"text-h6"},"Filter Agents",-1),xe={class:"row project_table_filters_any_filter"},Be={class:"project_table_filters_any_filter_button"},Ie={class:"project_table_filters_any_filter_button"},De={class:"project_table_filters_any_filter_button"},Le=_("div",{class:"text-h6"},"Filter Sources",-1),Ue={class:"row project_table_filters_any_filter"},Ne={class:"project_table_filters_any_filter_button"},We={class:"project_table_filters_any_filter_button"},Me={class:"project_table_filters_any_filter_button"};function Ge(e,t,o,l,r,u){return d(),f("div",null,[s(W,{clickable:"",onClick:t[0]||(t[0]=a=>e.click_filter_chip("Stages")),removable:e.isFiltered("Stages"),onRemove:e.click_stages_select_all,color:"primary","text-color":"white","icon-remove":"close"},{default:n(()=>[v(C(e.filter_text("Stages")),1)]),_:1},8,["removable","onRemove"]),s(W,{clickable:"",onClick:t[1]||(t[1]=a=>e.click_filter_chip("Agents")),removable:e.isFiltered("Agents"),onRemove:e.click_agents_select_all,color:"primary","text-color":"white","icon-remove":"close"},{default:n(()=>[v(C(e.filter_text("Agents")),1)]),_:1},8,["removable","onRemove"]),s(W,{clickable:"",onClick:t[2]||(t[2]=a=>e.click_filter_chip("Sources")),removable:e.isFiltered("Sources"),onRemove:e.click_sources_select_all,color:"primary","text-color":"white","icon-remove":"close"},{default:n(()=>[v(C(e.filter_text("Sources")),1)]),_:1},8,["removable","onRemove"]),s(R,{modelValue:e.dialog_stages,"onUpdate:modelValue":t[3]||(t[3]=a=>e.dialog_stages=a)},{default:n(()=>[s(U,{class:"todoitem-dialogcard"},{default:n(()=>[s(T,{class:"row items-center q-pb-none"},{default:n(()=>[Se,s(M),$(s(m,{icon:"close",flat:"",round:"",dense:""},null,512),[[S]])]),_:1}),s(T,null,{default:n(()=>[_("div",Re,[_("div",Ve,[(d(!0),f(V,null,F(e.stages,a=>(d(),f("div",{key:a.workflow_stage_id},[s(N,{modelValue:a.selected,"onUpdate:modelValue":i=>a.selected=i,label:a.stage.name,onClick:e.emit_filter_changed_signal},null,8,["modelValue","onUpdate:modelValue","label","onClick"])]))),128))]),_("div",Fe,[_("div",Qe,[s(m,{color:"primary",label:"Select all",onClick:e.click_stages_select_all},null,8,["onClick"])]),_("div",Ee,[s(m,{color:"primary",label:"Select none",onClick:e.click_stages_select_none},null,8,["onClick"])]),_("div",qe,[s(m,{color:"primary",label:"Select active",onClick:e.click_stages_select_active},null,8,["onClick"])]),_("div",Ae,[s(m,{color:"secondary",label:"Close",onClick:e.close_all_dialogs},null,8,["onClick"])])])])]),_:1})]),_:1})]),_:1},8,["modelValue"]),s(R,{modelValue:e.dialog_agents,"onUpdate:modelValue":t[4]||(t[4]=a=>e.dialog_agents=a)},{default:n(()=>[s(U,{class:"todoitem-dialogcard"},{default:n(()=>[s(T,{class:"row items-center q-pb-none"},{default:n(()=>[ze,s(M),$(s(m,{icon:"close",flat:"",round:"",dense:""},null,512),[[S]])]),_:1}),s(T,null,{default:n(()=>[_("div",xe,[(d(!0),f(V,null,F(e.agents,a=>(d(),f("div",{key:a.name},[s(N,{modelValue:a.selected,"onUpdate:modelValue":i=>a.selected=i,label:a.name,onClick:e.emit_filter_changed_signal},null,8,["modelValue","onUpdate:modelValue","label","onClick"])]))),128)),_("div",Be,[s(m,{color:"primary",label:"Select all",onClick:e.click_agents_select_all},null,8,["onClick"])]),_("div",Ie,[s(m,{color:"primary",label:"Select none",onClick:e.click_agents_select_none},null,8,["onClick"])]),_("div",De,[s(m,{color:"secondary",label:"Close",onClick:e.close_all_dialogs},null,8,["onClick"])])])]),_:1})]),_:1})]),_:1},8,["modelValue"]),s(R,{modelValue:e.dialog_sources,"onUpdate:modelValue":t[5]||(t[5]=a=>e.dialog_sources=a)},{default:n(()=>[s(U,{class:"todoitem-dialogcard"},{default:n(()=>[s(T,{class:"row items-center q-pb-none"},{default:n(()=>[Le,s(M),$(s(m,{icon:"close",flat:"",round:"",dense:""},null,512),[[S]])]),_:1}),s(T,null,{default:n(()=>[_("div",Ue,[(d(!0),f(V,null,F(e.sources,a=>(d(),f("div",{key:a.name},[s(N,{modelValue:a.selected,"onUpdate:modelValue":i=>a.selected=i,label:a.name,onClick:e.emit_filter_changed_signal},null,8,["modelValue","onUpdate:modelValue","label","onClick"])]))),128)),_("div",Ne,[s(m,{color:"primary",label:"Select all",onClick:e.click_sources_select_all},null,8,["onClick"])]),_("div",We,[s(m,{color:"primary",label:"Select none",onClick:e.click_sources_select_none},null,8,["onClick"])]),_("div",Me,[s(m,{color:"secondary",label:"Close",onClick:e.close_all_dialogs},null,8,["onClick"])])])]),_:1})]),_:1})]),_:1},8,["modelValue"])])}var He=x(Pe,[["render",Ge]]);const Ye=z({name:"ToolsCansavePatchePage",props:["projects","prefiltered","cumulatively_loaded_stages","cumulatively_loaded_agents","cumulatively_loaded_sources"],emits:["filterchanged"],components:{CommonBRRToolLink:ve,ProjectTableFilters:He},setup(){return{backend_connection_store:H()}},data(){return{filter:"",columns:[{name:"address",required:!0,label:"Address",align:"left",field:"address",sortable:!0},{name:"workflowstage",required:!0,label:"Stage",align:"left",field:"stage",sortable:!0},{name:"visionandnotes",required:!0,label:"Vision and Notes",align:"left",field:"vandnotes",sortable:!1},{name:"source",required:!0,label:"Source",align:"left",field:"source",sortable:!0},{name:"agent",required:!0,label:"Agent",align:"left",field:"selling_agent",sortable:!0},{name:"todo",required:!0,label:"Todos",align:"left",field:"todo",sortable:!1}],initialPagination:{rowsPerPage:50}}},computed:{filter_stages_options(){return[{label:"Call Agent",value:"agent"},{label:"Call Sourcer",value:"sourcer"},{label:"Other",value:"other"}]},user_profile(){return this.backend_connection_store.user_profile},table_content(){const e=this;return this.projects.map(function(t){return t.loaded?{id:t.id,loaded:t.loaded,address:t.item.sub_section_details.dealbasicinfo.address,source:e.get_source_text(t),selling_agent:w.get_agent_text(t.item.sub_section_details.dealbasicinfo.selling_agent),vandnotes:"NOT DISPLAYED",devplan:t.item.sub_section_details.vision.devplan,notes:t.item.sub_section_details.dealbasicinfo.notes,stage:e.getWorkflowStage(t.item.workflow).name,todo:e.get_todo_text(t)}:{id:t.id,loaded:!1,address:"Loading...",source:"",selling_agent:"",vandnotes:"",devplan:"",notes:"",stage:"",todo:""}})}},methods:{get_current_filter(){return this.$refs.ProjectTableFilters.get_current_filter()},set_selected_stages(e){this.$refs.ProjectTableFilters.set_selected_stages(e)},get_todo_text(e){let t=0,o=0,l=0;return typeof e.item.todos!="undefined"&&(t=e.item.todos.filter(function(r){return!r.done&&!r.due}).length,o=e.item.todos.filter(function(r){return!r.done&&r.due}).length,l=e.item.todos.filter(function(r){return r.done}).length),o.toString()+"/"+(t+o).toString()+" ("+l.toString()+")"},get_source_text(e){return w.get_source_text(e.item.sub_section_details.dealbasicinfo.deal_source)},getWorkflowStage({workflow_used_id:e,current_stage:t}){return y.workflows[e].stages[t]},onRowClick(e,t){if(t){const o=this.$router.resolve("/tools/brrcalc"),l=new URL(o.href,window.location.origin+window.location.pathname).href+"?projectid="+e.id;window.open(l),window.focus();return}this.$router.push("/tools/brrcalc?projectid="+e.id)}},mounted(){}}),Ke={class:"projecttablecontainer"},Oe={class:"projecttablestyle"},Xe=_("th",{align:"left"},[v("Todo"),_("br"),v("due/total (done)")],-1),Je={key:0},Ze={class:"projecttablehead"},et={key:0},tt={key:0},lt={key:0},ot={key:1},st={key:1};function at(e,t,o,l,r,u){const a=P("ProjectTableFilters"),i=P("CommonBRRToolLink");return d(),f("div",Ke,[_("div",Oe,[s(a,{ref:"ProjectTableFilters",projects:e.projects,cumulatively_loaded_stages:e.cumulatively_loaded_stages,cumulatively_loaded_agents:e.cumulatively_loaded_agents,cumulatively_loaded_sources:e.cumulatively_loaded_sources,onFilterchanged:t[0]||(t[0]=c=>e.$emit("filterchanged",c))},null,8,["projects","cumulatively_loaded_stages","cumulatively_loaded_agents","cumulatively_loaded_sources"]),s(he,{flat:"",bordered:"",title:"Projects",rows:e.table_content,columns:e.columns,filter:e.filter,pagination:e.initialPagination,"no-data-label":"I didn't find anything for you","no-results-label":"The filter didn't uncover any results","row-key":"name",onRowClick:t[2]||(t[2]=(c,g,b)=>e.onRowClick(g,!1))},{"header-cell-todo":n(()=>[Xe]),"body-cell-address":n(c=>[s(X,null,{default:n(()=>[s($e,{"context-menu":""},{default:n(()=>[s(je,null,{default:n(()=>[s(ge,{style:{"min-width":"100px"}},{default:n(()=>[$((d(),A(O,{clickable:"",onClick:g=>e.onRowClick(c.row,!0)},{default:n(()=>[s(K,null,{default:n(()=>[v("Open in new tab...")]),_:1})]),_:2},1032,["onClick"])),[[S]]),s(ce),$((d(),A(O,{clickable:""},{default:n(()=>[s(K,null,{default:n(()=>[v("Cancel")]),_:1})]),_:1})),[[S]])]),_:2},1024)]),_:2},1024)]),_:2},1024),v(" "+C(c.row.address),1)]),_:2},1024)]),"body-cell-visionandnotes":n(c=>[s(X,null,{default:n(()=>[c.row.loaded?(d(),f("div",Je,[_("div",Ze,C(c.row.devplan),1),typeof c.row.notes!="undefined"?(d(),f("div",et,[(d(!0),f(V,null,F(c.row.notes.split(`
`),g=>(d(),f("div",{key:g},C(g),1))),128))])):k("",!0)])):k("",!0)]),_:2},1024)]),"top-right":n(()=>[s(de,{borderless:"",dense:"",debounce:"300",modelValue:e.filter,"onUpdate:modelValue":t[1]||(t[1]=c=>e.filter=c),clearable:"",placeholder:"Search"},{append:n(()=>[s(ue,{name:"search"})]),_:1},8,["modelValue"])]),"no-data":n(({})=>[e.prefiltered?k("",!0):(d(),f("div",tt,[e.projects.length===0?(d(),f("div",lt,[v(" No projects in this patch - use the BRR calculator to create one "),s(i)])):k("",!0),e.projects.length!==0?(d(),f("div",ot," No projects match the filter ")):k("",!0)])),e.prefiltered?(d(),f("div",st," No projects match the filter ")):k("",!0)]),_:1},8,["rows","columns","filter","pagination"])])])}var rt=x(Ye,[["render",at]]);function it(e,t,o,l){const r={items_drawn:{},cols:[-300,120,560]};G(e,t.initial_stage,t.stages[t.initial_stage],r,t,200,!1,o,l)}const Q=130,E=400;function nt(e,t,o){let l=0;return o?l=2:typeof e.draw_col!="undefined"&&(l=e.draw_col),t.cols[l]}function G(e,t,o,l,r,u,a,i,c){if(Object.keys(l.items_drawn).includes(t))return;const g=nt(o,l,a),b=e.append("g").attr("transform","translate( "+g+" "+u+")");l.items_drawn[t]={pos_x:g,pos_y:u},ct(b,t,o,a,i,r,c),typeof o.progression!="undefined"&&(typeof o.progression.failed!="undefined"&&(G(e,o.progression.failed,r.stages[o.progression.failed],l,r,u+150,!0,i,c),J(e,g,u+Q,l.cols[2]-E/2,u+150+Q/2)),typeof o.progression.success!="undefined"&&o.progression.success.forEach(function(p){G(e,p.next_stage,r.stages[p.next_stage],l,r,u+300,!1,i,c),J(e,g,u+Q,l.items_drawn[p.next_stage].pos_x,l.items_drawn[p.next_stage].pos_y)}))}function J(e,t,o,l,r){e.append("line").attr("x1",t).attr("y1",o).attr("x2",l).attr("y2",r).attr("stroke","black").attr("style","stroke-width:10;").attr("marker-end","url(#triangle)")}function ct(e,t,o,l,r,u,a){const i=e.append("g");let c="lightgreen";l&&(c="pink");function g(){r(t,o)}let b=0;if(typeof a.workflow_lookup!="undefined"&&typeof a.workflow_lookup[u.id]!="undefined"&&typeof a.workflow_lookup[u.id][t]!="undefined"&&(b=a.workflow_lookup[u.id][t].length),i.append("rect").attr("width",E).attr("height",Q).attr("x",-(E/2)).attr("y",0).attr("style","fill: "+c+";stroke-width:3;stroke:rgb(0,0,0)").on("click",g),i.append("text").attr("x",0).attr("y",50).attr("text-anchor","middle").style("font-size","28px").style("font-weight","500").text(o.name).on("click",g),i.append("text").attr("x",0).attr("y",110).attr("text-anchor","middle").style("font-size","56px").style("font-weight","500").text(b.toString()).on("click",g),typeof o.diagram_notes!="undefined"){let p=0;o.diagram_notes.split("<BR>").forEach(function(B){i.append("text").attr("x",-(E/2+20)).attr("y",p).attr("text-anchor","end").attr("alignment-baseline","text-before-edge").style("font-size","24px").style("font-weight","500").text(B),p=p+30})}}const dt=z({name:"WorkflowChart",props:["patch_data"],emits:["onclickstage"],data(){return{allzoomedelements:void 0,boudaryRect:void 0,svg:void 0,background_item_group:void 0,chartarea:{xmin:-950,xmax:950,ymin:-150,ymax:2300}}},computed:{workflow(){return y.workflows[y.default_workflow_id]}},methods:{initChart(){for(var e=this,t=function(l){var r=800,u=800;l.svg=be("svg").attr("style","border: 1px solid black;position:fixed; top:0; left:0; height:100%; width:100%").attr("viewBox",[-r/2,-u/2,r,u]).attr("oncontextmenu","return false;"),l.allzoomedelements=l.svg.append("g"),e.boudaryRect=l.allzoomedelements.append("rect").attr("width",l.chartarea.xmax-l.chartarea.xmin).attr("height",l.chartarea.ymax-l.chartarea.ymin).attr("x",l.chartarea.xmin).attr("y",l.chartarea.ymin).attr("style","fill: white;stroke-width:3;stroke:rgb(0,0,0)"),l.svg.call(ye().extent([[0,0],[r,u]]).scaleExtent([-5,10]).on("zoom",a)),l.svg.on("dblclick.zoom",null);function a(i,c){l.allzoomedelements.attr("transform",i.transform)}return l.allzoomedelements.append("text").attr("text-anchor","middle").attr("alignment-baseline","central").attr("x",0).attr("y",-70).attr("style","font-size: 60px; font-weight: 800;").text(i=>e.workflow.name),l.allzoomedelements.append("text").attr("text-anchor","middle").attr("alignment-baseline","central").attr("x",0).attr("y",-0).attr("style","font-size: 50px; font-weight: 300;").text(i=>"Projects for patch "+e.patch_data.name),l.allzoomedelements.append("text").attr("text-anchor","middle").attr("alignment-baseline","central").attr("x",0).attr("y",60).attr("style","font-size: 40px; font-weight: 300;").text(i=>"(Note: Diagram only - workflows not yet implemented)"),l.svg.node()},o=document.getElementById("chartInsetionPoint_workflowchart");o.firstChild;)console.log("Removing old SVG"),o.removeChild(o.firstChild);o.appendChild(t(this)),this.svg.append("marker").attr("id","triangle").attr("viewBox","0 0 10 10").attr("refX","8").attr("refY","5").attr("markerUnits","strokeWidth").attr("markerWidth","4").attr("markerHeight","4").attr("orient","auto").attr("fill","black").append("path").attr("d","M 0 0 L 10 5 L 0 10 z"),it(this.allzoomedelements,this.workflow,this.click_stage_callback,this.patch_data)},click_stage_callback(e,t){this.$emit("onclickstage",this.workflow.id,e,t)},clickDIV(){}},mounted(){this.initChart()}});function ut(e,t,o,l,r,u){return d(),f("div",{id:"chartInsetionPoint_workflowchart",onClick:t[0]||(t[0]=a=>e.clickDIV(a))})}var _t=x(dt,[["render",ut]]);const ft=z({name:"ToolsCansavePatchePage",components:{ProjectTable:rt,WrokflowChart:_t,TodoDisplay:we},setup(){const e=H(),t=Te();return{backend_connection_store:e,patch_local_settings_store:t}},data(){return{loaded:!1,patch_data:{},loaded_projects:[],filtered_loaded_projects:[],project_filter:{filter_stages:!0,selected_stages:[],filter_agents:!0,selected_agents:[],filter_sources:!0,selected_sources:[]},tab:"projects"}},watch:{loaded_projects(e){this.recompute_filtered_projects()}},computed:{cumulatively_loaded_stages:{get(){return this.patch_local_settings_store.findPatchRecord(this.patch_data.id).cumulatively_loaded_stages}},cumulatively_loaded_sources:{get(){return this.patch_local_settings_store.findPatchRecord(this.patch_data.id).cumulatively_loaded_sources}},cumulatively_loaded_agents:{get(){return this.patch_local_settings_store.findPatchRecord(this.patch_data.id).cumulatively_loaded_agents}},selectedStageText(){return y.workflows[this.selected_stage.workflow_id].stages[this.selected_stage.stage_id].name},user_profile(){return this.backend_connection_store.user_profile}},methods:{btn_click_workflow(){this.tab="workflow"},projecttablefilterchanged(e){this.project_filter.filter_stages=!0,this.project_filter.selected_stages=e.selected_stages,this.project_filter.filter_agents=!0,this.project_filter.selected_agents=e.selected_agents,this.project_filter.filter_sources=!0,this.project_filter.selected_sources=e.selected_sources,this.recompute_filtered_projects()},_recompute_filtered_projects_stage_filter(e){if(!this.project_filter.filter_stages)return!0;const t=y.get_workflow_stage_key(e.item.workflow.workflow_used_id,e.item.workflow.current_stage);return!!this.project_filter.selected_stages.includes(t)},_recompute_filtered_projects_agent_filter(e){if(!this.project_filter.filter_agents)return!0;const t=w.get_agent_text(e.item.sub_section_details.dealbasicinfo.selling_agent);return!!this.project_filter.selected_agents.includes(t)},_recompute_filtered_projects_source_filter(e){if(!this.project_filter.filter_sources)return!0;const t=w.get_source_text(e.item.sub_section_details.dealbasicinfo.deal_source);return!!this.project_filter.selected_sources.includes(t)},is_project_included_in_current_filters(e){return!(!this._recompute_filtered_projects_stage_filter(e)||!this._recompute_filtered_projects_agent_filter(e)||!this._recompute_filtered_projects_source_filter(e))},recompute_filtered_projects(){const e=this;this.filtered_loaded_projects=this.loaded_projects.filter(function(t){return t.loaded?e.is_project_included_in_current_filters(t):!0})},onchartclickstage(e,t,o){const l=this;this.tab="projects",setTimeout(function(){const r=y.get_workflow_stage_key(e,t);l.$refs.ProjectTableRef.set_selected_stages([r])},5)},clicknewproject(){this.$router.push("/tools/brrcalc?patchid="+this.$route.params.patchid)},click_brrr_card(){this.$router.push("/tools/brrcalc")},refresh(){const e=this,t={ok:e.refresh_success,error:function(o){_e.create({color:"negative",message:"Failed to find patch information",timeout:2e3}),e.$router.push("/tools/cansave/patches")}};this.backend_connection_store.call_api({apiprefix:"privateUserAPIPrefix",url:"/patches/"+e.$route.params.patchid,method:"GET",data:void 0,callback:t})},refresh_success(e){this.patch_data=e.data,this.loaded_projects=this.patch_data.projects.map(function(t){return{id:t,loaded:!1,item:void 0}}),this.recursive_load_project_details(),this.loaded=!0},recursive_load_project_details(){const e=this.loaded_projects.filter(function(r){return r.loaded===!1});if(e.length===0)return;const t=e[0],o=this,l={ok:function(r){t.loaded=!0,t.item=r.data,o.add_to_cumulatively_loaded(r.data),o.projecttablefilterchanged(o.$refs.ProjectTableRef.get_current_filter()),o.recompute_filtered_projects(),o.recursive_load_project_details()},error:function(r){t.loaded=!0,t.address="TODO LOAD FAIL",o.recursive_load_project_details()}};this.backend_connection_store.call_api({apiprefix:"privateUserAPIPrefix",url:"/projects/"+t.id,method:"GET",data:void 0,callback:l})},add_to_cumulatively_loaded(e){const t=y.get_workflow_stage_key(e.workflow.workflow_used_id,e.workflow.current_stage),o=w.get_source_text(e.sub_section_details.dealbasicinfo.deal_source),l=w.get_agent_text(e.sub_section_details.dealbasicinfo.selling_agent);this.patch_local_settings_store.reportFoundProject({patch_id:this.patch_data.id,workflow_stage_id:t,workflow_id:e.workflow.workflow_used_id,stage_id:e.workflow.current_stage,stage:y.getWorkflowStage(e.workflow.workflow_used_id,e.workflow.current_stage),stage_selected:w.boolean_undefined_to_false(y.workflows[e.workflow.workflow_used_id].stages[e.workflow.current_stage].active),source:o,source_selected:!0,agent:l,agent_selected:!0}),o in this.cumulatively_loaded_sources||(this.cumulatively_loaded_sources[o]={name:o,selected:!0}),l in this.cumulatively_loaded_agents||(this.cumulatively_loaded_agents[l]={name:l,selected:!0})}},mounted(){this.loaded=!1,this.refresh()}}),gt={key:0},ht=_("h1",null,"Loading...",-1),mt=[ht],pt={key:1},kt={key:0},vt={key:2},bt={key:3},yt={key:4};function wt(e,t,o,l,r,u){const a=P("ProjectTable"),i=P("TodoDisplay"),c=P("WrokflowChart");return d(),A(fe,{class:"patchpageclass"},{default:n(()=>[e.loaded?k("",!0):(d(),f("div",gt,mt)),e.loaded?(d(),f("div",pt,[e.tab!=="workflow"?(d(),f("h1",kt,C(e.patch_data.name),1)):k("",!0),e.tab!=="workflow"?(d(),A(oe,{key:1,modelValue:e.tab,"onUpdate:modelValue":t[0]||(t[0]=g=>e.tab=g),dense:"",class:"text-grey","active-color":"primary","indicator-color":"primary",align:"justify","narrow-indicator":""},{default:n(()=>[s(Y,{name:"projects",label:"Projects"}),s(Y,{name:"todos",label:"Todos"})]),_:1},8,["modelValue"])):k("",!0),e.tab==="projects"?(d(),f("div",vt,[_("h2",null,[v(" Projects "),s(m,{label:"Pick from workflow",color:"primary",onClick:e.btn_click_workflow,class:"float-right"},null,8,["onClick"])]),_("div",null,[s(a,{ref:"ProjectTableRef",projects:e.filtered_loaded_projects,prefiltered:!0,cumulatively_loaded_stages:e.cumulatively_loaded_stages,cumulatively_loaded_agents:e.cumulatively_loaded_agents,cumulatively_loaded_sources:e.cumulatively_loaded_sources,onFilterchanged:e.projecttablefilterchanged},null,8,["projects","cumulatively_loaded_stages","cumulatively_loaded_agents","cumulatively_loaded_sources","onFilterchanged"])]),s(m,{color:"primary",label:"Add Project",onClick:e.clicknewproject},null,8,["onClick"])])):k("",!0),e.tab==="todos"?(d(),f("div",bt,[s(i,{patch_id:e.patch_data.id},null,8,["patch_id"])])):k("",!0),e.tab==="workflow"?(d(),f("div",yt,[s(c,{patch_data:e.patch_data,onOnclickstage:e.onchartclickstage},null,8,["patch_data","onOnclickstage"])])):k("",!0)])):k("",!0)]),_:1})}var Dt=x(ft,[["render",wt]]);export{Dt as default};
