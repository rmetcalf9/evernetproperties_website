import{Q as L,a as E}from"./QTabs.586f3604.js";import{d as P,_ as V,o as r,K as n,e as c,L as v,M as j,a as i,au as z,a8 as g,r as w,w as p,t as T,ar as m,af as N,a7 as Q,f as C,N as W,c as B}from"./index.2d092be1.js";import{Q as A}from"./QPage.4e068d69.js";import{u as R}from"./backend_connection.48d9f5f6.js";import{b as D,Q as U}from"./QTable.c5302c18.js";import{C as q}from"./CommonBRRToolLink.3c8812d5.js";import{W as k}from"./Workflow_main.48c4f03b.js";import{u as y}from"./utils.b0f5af30.js";import{c as G,z as M}from"./zoom.2619b28f.js";import{T as Y}from"./TodoDisplay.36156813.js";import"./QResizeObserver.214c0776.js";import"./QSelect.e30d0ee3.js";import"./QItemLabel.a13df94b.js";import"./position-engine.7246b193.js";import"./axios.6e1fcf85.js";import"./TodoItem.4f7c566f.js";import"./ClosePopup.c6032047.js";const H=P({name:"ProjectTableFilterComponent",props:["projects","cumulatively_loaded_stages","cumulatively_loaded_agents","cumulatively_loaded_sources"],emits:["filterchanged"],components:{},setup(){return{backend_connection_store:R()}},data(){return{}},computed:{stages(){const e=this;let t=[];return Object.keys(e.cumulatively_loaded_stages).forEach(function(o){t.push(e.cumulatively_loaded_stages[o])}),t},agents(){const e=this;let t=[];return Object.keys(e.cumulatively_loaded_agents).forEach(function(o){t.push(e.cumulatively_loaded_agents[o])}),t},sources(){const e=this;let t=[];return Object.keys(e.cumulatively_loaded_sources).forEach(function(o){t.push(e.cumulatively_loaded_sources[o])}),t},filter_stages_options(){return[{label:"Call Agent",value:"agent"},{label:"Call Sourcer",value:"sourcer"},{label:"Other",value:"other"}]},isStageSelected(e){return!0}},methods:{set_selected_stages(e){this.stages.forEach(function(t){e.includes(t.workflow_stage_id)?t.selected=!0:t.selected=!1}),this.emit_filter_changed_signal()},emit_filter_changed_signal(){let e=[];this.stages.forEach(function(l){l.selected&&e.push(l.workflow_stage_id)});let t=[];this.agents.forEach(function(l){l.selected&&t.push(l.name)});let o=[];this.sources.forEach(function(l){l.selected&&o.push(l.name)}),this.$emit("filterchanged",{selected_stages:e,selected_agents:t,selected_sources:o})},click_stages_select_none(){this.stages.forEach(function(e){e.selected=!1}),this.emit_filter_changed_signal()},click_stages_select_all(){this.stages.forEach(function(e){e.selected=!0}),this.emit_filter_changed_signal()},click_agents_select_none(){this.agents.forEach(function(e){e.selected=!1}),this.emit_filter_changed_signal()},click_agents_select_all(){this.agents.forEach(function(e){e.selected=!0}),this.emit_filter_changed_signal()},click_sources_select_none(){this.sources.forEach(function(e){e.selected=!1}),this.emit_filter_changed_signal()},click_sources_select_all(){this.sources.forEach(function(e){e.selected=!0}),this.emit_filter_changed_signal()},click_stages_select_active(){this.stages.forEach(function(e){let t=!1;typeof e.stage.active!="undefined"&&(t=e.stage.active),e.selected=t}),this.emit_filter_changed_signal()}},mounted(){}}),K={class:"row project_table_filters_any_filter"},X=c("div",null,"Stage:",-1),J={class:"project_table_filters_any_filter_button"},Z={class:"project_table_filters_any_filter_button"},O={class:"project_table_filters_any_filter_button"},ee={class:"row project_table_filters_any_filter"},te=c("div",null,"Agent:",-1),le={class:"project_table_filters_any_filter_button"},oe={class:"project_table_filters_any_filter_button"},se={class:"row project_table_filters_any_filter"},ae=c("div",null,"Source:",-1),re={class:"project_table_filters_any_filter_button"},ie={class:"project_table_filters_any_filter_button"};function ne(e,t,o,l,s,_){return r(),n(v,null,[c("div",K,[X,(r(!0),n(v,null,j(e.stages,a=>(r(),n("div",{key:a.workflow_stage_id},[i(z,{modelValue:a.selected,"onUpdate:modelValue":d=>a.selected=d,label:a.stage.name,onClick:e.emit_filter_changed_signal},null,8,["modelValue","onUpdate:modelValue","label","onClick"])]))),128)),c("div",J,[i(g,{color:"primary",label:"Select all",onClick:e.click_stages_select_all},null,8,["onClick"])]),c("div",Z,[i(g,{color:"primary",label:"Select none",onClick:e.click_stages_select_none},null,8,["onClick"])]),c("div",O,[i(g,{color:"primary",label:"Select active",onClick:e.click_stages_select_active},null,8,["onClick"])])]),c("div",ee,[te,(r(!0),n(v,null,j(e.agents,a=>(r(),n("div",{key:a.name},[i(z,{modelValue:a.selected,"onUpdate:modelValue":d=>a.selected=d,label:a.name,onClick:e.emit_filter_changed_signal},null,8,["modelValue","onUpdate:modelValue","label","onClick"])]))),128)),c("div",le,[i(g,{color:"primary",label:"Select all",onClick:e.click_agents_select_all},null,8,["onClick"])]),c("div",oe,[i(g,{color:"primary",label:"Select none",onClick:e.click_agents_select_none},null,8,["onClick"])])]),c("div",se,[ae,(r(!0),n(v,null,j(e.sources,a=>(r(),n("div",{key:a.name},[i(z,{modelValue:a.selected,"onUpdate:modelValue":d=>a.selected=d,label:a.name,onClick:e.emit_filter_changed_signal},null,8,["modelValue","onUpdate:modelValue","label","onClick"])]))),128)),c("div",re,[i(g,{color:"primary",label:"Select all",onClick:e.click_sources_select_all},null,8,["onClick"])]),c("div",ie,[i(g,{color:"primary",label:"Select none",onClick:e.click_sources_select_none},null,8,["onClick"])])])],64)}var de=V(H,[["render",ne]]);const ce=P({name:"ToolsCansavePatchePage",props:["projects","prefiltered","cumulatively_loaded_stages","cumulatively_loaded_agents","cumulatively_loaded_sources"],emits:["filterchanged"],components:{CommonBRRToolLink:q,ProjectTableFilters:de},setup(){return{backend_connection_store:R()}},data(){return{filter:"",columns:[{name:"address",required:!0,label:"Address",align:"left",field:"address",sortable:!0},{name:"workflowstage",required:!0,label:"Stage",align:"left",field:"stage",sortable:!0},{name:"visionandnotes",required:!0,label:"Vision and Notes",align:"left",field:"vandnotes",sortable:!1},{name:"source",required:!0,label:"Source",align:"left",field:"source",sortable:!0},{name:"agent",required:!0,label:"Agent",align:"left",field:"selling_agent",sortable:!0},{name:"todo",required:!0,label:"Todos",align:"left",field:"todo",sortable:!1}],initialPagination:{rowsPerPage:50}}},computed:{filter_stages_options(){return[{label:"Call Agent",value:"agent"},{label:"Call Sourcer",value:"sourcer"},{label:"Other",value:"other"}]},user_profile(){return this.backend_connection_store.user_profile},table_content(){const e=this;return this.projects.map(function(t){return t.loaded?{id:t.id,loaded:t.loaded,address:t.item.sub_section_details.dealbasicinfo.address,source:e.get_source_text(t),selling_agent:y.get_agent_text(t.item.sub_section_details.dealbasicinfo.selling_agent),vandnotes:"NOT DISPLAYED",devplan:t.item.sub_section_details.vision.devplan,notes:t.item.sub_section_details.dealbasicinfo.notes,stage:e.getWorkflowStage(t.item.workflow).name,todo:e.get_todo_text(t)}:{id:t.id,loaded:!1,address:"Loading...",source:"",selling_agent:"",vandnotes:"",devplan:"",notes:"",stage:"",todo:""}})}},methods:{set_selected_stages(e){this.$refs.ProjectTableFilters.set_selected_stages(e)},get_todo_text(e){let t=0,o=0,l=0;return typeof e.item.todos!="undefined"&&(t=e.item.todos.filter(function(s){return!s.done&&!s.due}).length,o=e.item.todos.filter(function(s){return!s.done&&s.due}).length,l=e.item.todos.filter(function(s){return s.done}).length),o.toString()+"/"+(t+o).toString()+" ("+l.toString()+")"},get_source_text(e){return y.get_source_text(e.item.sub_section_details.dealbasicinfo.deal_source)},getWorkflowStage({workflow_used_id:e,current_stage:t}){return k.workflows[e].stages[t]},onRowClick(e){this.$router.push("/tools/brrcalc?projectid="+e.id)}},mounted(){}}),_e={class:"projecttablecontainer"},ue={class:"projecttablestyle"},fe=c("th",{align:"left"},[C("Todo"),c("br"),C("due/total (done)")],-1),me={key:0},ge={class:"projecttablehead"},he={key:0},pe={key:0},ke={key:0},ye={key:1},be={key:1};function ve(e,t,o,l,s,_){const a=w("ProjectTableFilters"),d=w("CommonBRRToolLink");return r(),n("div",_e,[c("div",ue,[i(a,{ref:"ProjectTableFilters",projects:e.projects,cumulatively_loaded_stages:e.cumulatively_loaded_stages,cumulatively_loaded_agents:e.cumulatively_loaded_agents,cumulatively_loaded_sources:e.cumulatively_loaded_sources,onFilterchanged:t[0]||(t[0]=u=>e.$emit("filterchanged",u))},null,8,["projects","cumulatively_loaded_stages","cumulatively_loaded_agents","cumulatively_loaded_sources"]),i(U,{flat:"",bordered:"",title:"Projects",rows:e.table_content,columns:e.columns,filter:e.filter,pagination:e.initialPagination,"no-data-label":"I didn't find anything for you","no-results-label":"The filter didn't uncover any results","row-key":"name",onRowClick:t[2]||(t[2]=(u,f,b)=>e.onRowClick(f))},{"header-cell-todo":p(()=>[fe]),"body-cell-visionandnotes":p(u=>[i(D,null,{default:p(()=>[u.row.loaded?(r(),n("div",me,[c("div",ge,T(u.row.devplan),1),typeof u.row.notes!="undefined"?(r(),n("div",he,[(r(!0),n(v,null,j(u.row.notes.split(`
`),f=>(r(),n("div",{key:f},T(f),1))),128))])):m("",!0)])):m("",!0)]),_:2},1024)]),"top-right":p(()=>[i(N,{borderless:"",dense:"",debounce:"300",modelValue:e.filter,"onUpdate:modelValue":t[1]||(t[1]=u=>e.filter=u),clearable:"",placeholder:"Search"},{append:p(()=>[i(Q,{name:"search"})]),_:1},8,["modelValue"])]),"no-data":p(({})=>[e.prefiltered?m("",!0):(r(),n("div",pe,[e.projects.length===0?(r(),n("div",ke,[C(" No projects in this patch - use the BRR calculator to create one "),i(d)])):m("",!0),e.projects.length!==0?(r(),n("div",ye," No projects match the filter ")):m("",!0)])),e.prefiltered?(r(),n("div",be," No projects match the filter ")):m("",!0)]),_:1},8,["rows","columns","filter","pagination"])])])}var we=V(ce,[["render",ve]]);function Te(e,t,o,l){const s={items_drawn:{},cols:[-300,120,560]};x(e,t.initial_stage,t.stages[t.initial_stage],s,t,200,!1,o,l)}const $=130,S=400;function Ce(e,t,o){let l=0;return o?l=2:typeof e.draw_col!="undefined"&&(l=e.draw_col),t.cols[l]}function x(e,t,o,l,s,_,a,d,u){if(Object.keys(l.items_drawn).includes(t))return;const f=Ce(o,l,a),b=e.append("g").attr("transform","translate( "+f+" "+_+")");l.items_drawn[t]={pos_x:f,pos_y:_},je(b,t,o,a,d,s,u),typeof o.progression!="undefined"&&(typeof o.progression.failed!="undefined"&&(x(e,o.progression.failed,s.stages[o.progression.failed],l,s,_+150,!0,d,u),F(e,f,_+$,l.cols[2]-S/2,_+150+$/2)),typeof o.progression.success!="undefined"&&o.progression.success.forEach(function(h){x(e,h.next_stage,s.stages[h.next_stage],l,s,_+300,!1,d,u),F(e,f,_+$,l.items_drawn[h.next_stage].pos_x,l.items_drawn[h.next_stage].pos_y)}))}function F(e,t,o,l,s){e.append("line").attr("x1",t).attr("y1",o).attr("x2",l).attr("y2",s).attr("stroke","black").attr("style","stroke-width:10;").attr("marker-end","url(#triangle)")}function je(e,t,o,l,s,_,a){const d=e.append("g");let u="lightgreen";l&&(u="pink");function f(){s(t,o)}let b=0;if(typeof a.workflow_lookup!="undefined"&&typeof a.workflow_lookup[_.id]!="undefined"&&typeof a.workflow_lookup[_.id][t]!="undefined"&&(b=a.workflow_lookup[_.id][t].length),d.append("rect").attr("width",S).attr("height",$).attr("x",-(S/2)).attr("y",0).attr("style","fill: "+u+";stroke-width:3;stroke:rgb(0,0,0)").on("click",f),d.append("text").attr("x",0).attr("y",50).attr("text-anchor","middle").style("font-size","28px").style("font-weight","500").text(o.name).on("click",f),d.append("text").attr("x",0).attr("y",110).attr("text-anchor","middle").style("font-size","56px").style("font-weight","500").text(b.toString()).on("click",f),typeof o.diagram_notes!="undefined"){let h=0;o.diagram_notes.split("<BR>").forEach(function(I){d.append("text").attr("x",-(S/2+20)).attr("y",h).attr("text-anchor","end").attr("alignment-baseline","text-before-edge").style("font-size","24px").style("font-weight","500").text(I),h=h+30})}}const $e=P({name:"WorkflowChart",props:["patch_data"],emits:["onclickstage"],data(){return{allzoomedelements:void 0,boudaryRect:void 0,svg:void 0,background_item_group:void 0,chartarea:{xmin:-950,xmax:950,ymin:-150,ymax:2300}}},computed:{workflow(){return k.workflows[k.default_workflow_id]}},methods:{initChart(){for(var e=this,t=function(l){var s=800,_=800;l.svg=G("svg").attr("style","border: 1px solid black;position:fixed; top:0; left:0; height:100%; width:100%").attr("viewBox",[-s/2,-_/2,s,_]).attr("oncontextmenu","return false;"),l.allzoomedelements=l.svg.append("g"),e.boudaryRect=l.allzoomedelements.append("rect").attr("width",l.chartarea.xmax-l.chartarea.xmin).attr("height",l.chartarea.ymax-l.chartarea.ymin).attr("x",l.chartarea.xmin).attr("y",l.chartarea.ymin).attr("style","fill: white;stroke-width:3;stroke:rgb(0,0,0)"),l.svg.call(M().extent([[0,0],[s,_]]).scaleExtent([-5,10]).on("zoom",a)),l.svg.on("dblclick.zoom",null);function a(d,u){l.allzoomedelements.attr("transform",d.transform)}return l.allzoomedelements.append("text").attr("text-anchor","middle").attr("alignment-baseline","central").attr("x",0).attr("y",-70).attr("style","font-size: 60px; font-weight: 800;").text(d=>e.workflow.name),l.allzoomedelements.append("text").attr("text-anchor","middle").attr("alignment-baseline","central").attr("x",0).attr("y",-0).attr("style","font-size: 50px; font-weight: 300;").text(d=>"Projects for patch "+e.patch_data.name),l.allzoomedelements.append("text").attr("text-anchor","middle").attr("alignment-baseline","central").attr("x",0).attr("y",60).attr("style","font-size: 40px; font-weight: 300;").text(d=>"(Note: Diagram only - workflows not yet implemented)"),l.svg.node()},o=document.getElementById("chartInsetionPoint_workflowchart");o.firstChild;)console.log("Removing old SVG"),o.removeChild(o.firstChild);o.appendChild(t(this)),this.svg.append("marker").attr("id","triangle").attr("viewBox","0 0 10 10").attr("refX","8").attr("refY","5").attr("markerUnits","strokeWidth").attr("markerWidth","4").attr("markerHeight","4").attr("orient","auto").attr("fill","black").append("path").attr("d","M 0 0 L 10 5 L 0 10 z"),Te(this.allzoomedelements,this.workflow,this.click_stage_callback,this.patch_data)},click_stage_callback(e,t){this.$emit("onclickstage",this.workflow.id,e,t)},clickDIV(){}},mounted(){this.initChart()}});function Se(e,t,o,l,s,_){return r(),n("div",{id:"chartInsetionPoint_workflowchart",onClick:t[0]||(t[0]=a=>e.clickDIV(a))})}var Pe=V($e,[["render",Se]]);const Ve=P({name:"ToolsCansavePatchePage",components:{ProjectTable:we,WrokflowChart:Pe,TodoDisplay:Y},setup(){return{backend_connection_store:R()}},data(){return{loaded:!1,patch_data:{},loaded_projects:[],filtered_loaded_projects:[],selected_stage:{workflow_id:void 0,stage_id:void 0},cumulatively_loaded_stages:{},cumulatively_loaded_sources:{},cumulatively_loaded_agents:{},project_filter:{filter_stages:!1,selected_stages:[],filter_agents:!1,selected_agents:[],filter_sources:!1,selected_sources:[]},tab:"projects"}},watch:{loaded_projects(e){this.recompute_filtered_projects()}},computed:{isStageSelected(){return typeof this.selected_stage.workflow_id!="undefined"},selectedStageText(){return k.workflows[this.selected_stage.workflow_id].stages[this.selected_stage.stage_id].name},user_profile(){return this.backend_connection_store.user_profile}},methods:{projecttablefilterchanged(e){this.project_filter.filter_stages=!0,this.project_filter.selected_stages=e.selected_stages,this.project_filter.filter_agents=!0,this.project_filter.selected_agents=e.selected_agents,this.project_filter.filter_sources=!0,this.project_filter.selected_sources=e.selected_sources,this.recompute_filtered_projects()},_recompute_filtered_projects_stage_filter(e){if(!this.project_filter.filter_stages)return!0;const t=k.get_workflow_stage_key(e.item.workflow.workflow_used_id,e.item.workflow.current_stage);return!!this.project_filter.selected_stages.includes(t)},_recompute_filtered_projects_agent_filter(e){if(!this.project_filter.filter_agents)return!0;const t=y.get_agent_text(e.item.sub_section_details.dealbasicinfo.selling_agent);return!!this.project_filter.selected_agents.includes(t)},_recompute_filtered_projects_source_filter(e){if(!this.project_filter.filter_sources)return!0;const t=y.get_source_text(e.item.sub_section_details.dealbasicinfo.deal_source);return console.log("SSS",this.project_filter),!!this.project_filter.selected_sources.includes(t)},recompute_filtered_projects(){const e=this;this.filtered_loaded_projects=this.loaded_projects.filter(function(t){return!(!e._recompute_filtered_projects_stage_filter(t)||!e._recompute_filtered_projects_agent_filter(t)||!e._recompute_filtered_projects_source_filter(t))})},clearselectesstage(){this.selected_stage={workflow_id:void 0,stage_id:void 0},this.recompute_filtered_projects()},onchartclickstage(e,t,o){const l=this;this.tab="projects",setTimeout(function(){const s=k.get_workflow_stage_key(e,t);l.$refs.ProjectTableRef.set_selected_stages([s])},5)},clicknewproject(){this.$router.push("/tools/brrcalc?patchid="+this.$route.params.patchid)},click_brrr_card(){this.$router.push("/tools/brrcalc")},refresh(){const e=this,t={ok:e.refresh_success,error:function(o){W.create({color:"negative",message:"Failed to find patch information",timeout:2e3}),e.$router.push("/tools/cansave/patches")}};this.backend_connection_store.call_api({apiprefix:"privateUserAPIPrefix",url:"/patches/"+e.$route.params.patchid,method:"GET",data:void 0,callback:t})},refresh_success(e){this.patch_data=e.data,this.loaded_projects=this.patch_data.projects.map(function(t){return{id:t,loaded:!1,item:void 0}}),this.recursive_load_project_details(),this.loaded=!0},recursive_load_project_details(){const e=this.loaded_projects.filter(function(s){return s.loaded===!1});if(e.length===0)return;const t=e[0],o=this,l={ok:function(s){t.loaded=!0,t.item=s.data,o.add_to_cumulatively_loaded(s.data),o.recompute_filtered_projects(),o.recursive_load_project_details()},error:function(s){t.loaded=!0,t.address="TODO LOAD FAIL",o.recursive_load_project_details()}};this.backend_connection_store.call_api({apiprefix:"privateUserAPIPrefix",url:"/projects/"+t.id,method:"GET",data:void 0,callback:l})},add_to_cumulatively_loaded(e){const t=k.get_workflow_stage_key(e.workflow.workflow_used_id,e.workflow.current_stage);t in this.cumulatively_loaded_stages||(this.cumulatively_loaded_stages[t]={workflow_stage_id:t,workflow_id:e.workflow.workflow_used_id,stage_id:e.workflow.current_stage,stage:k.getWorkflowStage(e.workflow.workflow_used_id,e.workflow.current_stage),selected:!0});const o=y.get_source_text(e.sub_section_details.dealbasicinfo.deal_source);o in this.cumulatively_loaded_sources||(this.cumulatively_loaded_sources[o]={name:o,selected:!0});const l=y.get_agent_text(e.sub_section_details.dealbasicinfo.selling_agent);l in this.cumulatively_loaded_agents||(this.cumulatively_loaded_agents[l]={name:l,selected:!0})}},mounted(){this.loaded=!1,this.refresh()}}),Ee={key:0},ze=c("h1",null,"Loading...",-1),xe=[ze],Re={key:1},Be={key:0},Fe={key:2},Ie=c("h2",null,"Projects",-1),Le={key:0,class:"selected_stage"},Ne={key:3},Qe={key:4};function We(e,t,o,l,s,_){const a=w("ProjectTable"),d=w("TodoDisplay"),u=w("WrokflowChart");return r(),B(A,{class:"patchpageclass"},{default:p(()=>[e.loaded?m("",!0):(r(),n("div",Ee,xe)),e.loaded?(r(),n("div",Re,[e.tab!=="workflow"?(r(),n("h1",Be,T(e.patch_data.name),1)):m("",!0),e.tab!=="workflow"?(r(),B(L,{key:1,modelValue:e.tab,"onUpdate:modelValue":t[0]||(t[0]=f=>e.tab=f),dense:"",class:"text-grey","active-color":"primary","indicator-color":"primary",align:"justify","narrow-indicator":""},{default:p(()=>[i(E,{name:"projects",label:"Projects"}),i(E,{name:"todos",label:"Todos"}),i(E,{name:"workflow",label:"Workflow"})]),_:1},8,["modelValue"])):m("",!0),e.tab==="projects"?(r(),n("div",Fe,[Ie,C("Source:"+T(e.cumulatively_loaded_sources)+" ",1),e.isStageSelected?(r(),n("div",Le,[C(" Stage "+T(e.selectedStageText)+" ",1),i(g,{color:"primary",icon:"close",round:"",onClick:e.clearselectesstage},null,8,["onClick"])])):m("",!0),c("div",null,[i(a,{ref:"ProjectTableRef",projects:e.filtered_loaded_projects,prefiltered:e.isStageSelected,cumulatively_loaded_stages:e.cumulatively_loaded_stages,cumulatively_loaded_agents:e.cumulatively_loaded_agents,cumulatively_loaded_sources:e.cumulatively_loaded_sources,onFilterchanged:e.projecttablefilterchanged},null,8,["projects","prefiltered","cumulatively_loaded_stages","cumulatively_loaded_agents","cumulatively_loaded_sources","onFilterchanged"])]),i(g,{color:"primary",label:"Add Project",onClick:e.clicknewproject},null,8,["onClick"])])):m("",!0),e.tab==="todos"?(r(),n("div",Ne,[i(d,{patch_id:e.patch_data.id},null,8,["patch_id"])])):m("",!0),e.tab==="workflow"?(r(),n("div",Qe,[i(u,{patch_data:e.patch_data,onOnclickstage:e.onchartclickstage},null,8,["patch_data","onOnclickstage"])])):m("",!0)])):m("",!0)]),_:1})}var st=V(Ve,[["render",We]]);export{st as default};
