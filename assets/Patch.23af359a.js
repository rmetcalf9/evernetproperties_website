import{Q as j,a as x}from"./QTabs.a5ee904d.js";import{d as C,_ as P,r as k,o as s,K as l,e as h,a as u,w as m,t as b,L as I,M as L,ar as f,af as N,a7 as D,f as v,N as Q,c as S,a8 as z}from"./index.d292944c.js";import{Q as W}from"./QPage.ea84df56.js";import{u as B}from"./backend_connection.8a638033.js";import{b as A,Q as E}from"./QTable.d28d2e26.js";import{C as q}from"./CommonBRRToolLink.e7e0fb91.js";import{W as T}from"./Workflow_main.6049b641.js";import{c as U,z as F}from"./zoom.2619b28f.js";import{T as G}from"./TodoDisplay.d4ad2aac.js";import"./QResizeObserver.47508c13.js";import"./QSelect.358cf801.js";import"./QItemLabel.83f1ba16.js";import"./position-engine.32164cbf.js";import"./axios.6e1fcf85.js";import"./TodoItem.b6e97ca5.js";import"./ClosePopup.ac1a737b.js";const M=C({name:"ToolsCansavePatchePage",props:["projects","prefiltered"],components:{CommonBRRToolLink:q},setup(){return{backend_connection_store:B()}},data(){return{filter:"",columns:[{name:"address",required:!0,label:"Address",align:"left",field:"address",sortable:!0},{name:"workflowstage",required:!0,label:"Stage",align:"left",field:"stage",sortable:!1},{name:"visionandnotes",required:!0,label:"Vision and Notes",align:"left",field:"vandnotes",sortable:!1},{name:"source",required:!0,label:"Source",align:"left",field:"source",sortable:!0},{name:"agent",required:!0,label:"Agent",align:"left",field:"selling_agent",sortable:!0},{name:"todo",required:!0,label:"Todos",align:"left",field:"todo",sortable:!1}],initialPagination:{rowsPerPage:50}}},computed:{user_profile(){return this.backend_connection_store.user_profile},table_content(){const e=this;return this.projects.map(function(t){return t.loaded?{id:t.id,loaded:t.loaded,address:t.item.sub_section_details.dealbasicinfo.address,source:e.get_source_text(t),selling_agent:t.item.sub_section_details.dealbasicinfo.selling_agent,vandnotes:"NOT DISPLAYED",devplan:t.item.sub_section_details.vision.devplan,notes:t.item.sub_section_details.dealbasicinfo.notes,stage:e.getWorkflowStage(t.item.workflow).name,todo:e.get_todo_text(t)}:{id:t.id,loaded:!1,address:"Loading...",source:"",selling_agent:"",vandnotes:"",devplan:"",notes:"",stage:"",todo:""}})}},methods:{get_todo_text(e){let t=0,r=0,o=0;return typeof e.item.todos!="undefined"&&(t=e.item.todos.filter(function(a){return!a.done&&!a.due}).length,r=e.item.todos.filter(function(a){return!a.done&&a.due}).length,o=e.item.todos.filter(function(a){return a.done}).length),r.toString()+"/"+(t+r).toString()+" ("+o.toString()+")"},get_source_text(e){return typeof e.item.sub_section_details.dealbasicinfo.deal_source=="undefined"||e.item.sub_section_details.dealbasicinfo.deal_source.type==="self"?"Self":e.item.sub_section_details.dealbasicinfo.deal_source.value},getWorkflowStage({workflow_used_id:e,current_stage:t}){return T.workflows[e].stages[t]},onRowClick(e){this.$router.push("/tools/brrcalc?projectid="+e.id)}},mounted(){}}),Y={class:"projecttablecontainer"},H={class:"projecttablestyle"},K=h("th",{align:"left"},[v("Todo"),h("br"),v("due/total (done)")],-1),X={key:0},J={class:"projecttablehead"},Z={key:0},O={key:0},ee={key:0},te={key:1},oe={key:1};function re(e,t,r,o,a,i){const d=k("CommonBRRToolLink");return s(),l("div",Y,[h("div",H,[u(E,{flat:"",bordered:"",title:"Projects",rows:e.table_content,columns:e.columns,filter:e.filter,pagination:e.initialPagination,"no-data-label":"I didn't find anything for you","no-results-label":"The filter didn't uncover any results","row-key":"name",onRowClick:t[1]||(t[1]=(n,c,p)=>e.onRowClick(c))},{"header-cell-todo":m(()=>[K]),"body-cell-visionandnotes":m(n=>[u(A,null,{default:m(()=>[n.row.loaded?(s(),l("div",X,[h("div",J,b(n.row.devplan),1),typeof n.row.notes!="undefined"?(s(),l("div",Z,[(s(!0),l(I,null,L(n.row.notes.split(`
`),c=>(s(),l("div",{key:c},b(c),1))),128))])):f("",!0)])):f("",!0)]),_:2},1024)]),"top-right":m(()=>[u(N,{borderless:"",dense:"",debounce:"300",modelValue:e.filter,"onUpdate:modelValue":t[0]||(t[0]=n=>e.filter=n),clearable:"",placeholder:"Search"},{append:m(()=>[u(D,{name:"search"})]),_:1},8,["modelValue"])]),"no-data":m(({})=>[e.prefiltered?f("",!0):(s(),l("div",O,[e.projects.length===0?(s(),l("div",ee,[v(" No projects in this patch - use the BRR calculator to create one "),u(d)])):f("",!0),e.projects.length!==0?(s(),l("div",te," No projects match the filter ")):f("",!0)])),e.prefiltered?(s(),l("div",oe," No projects match the filter ")):f("",!0)]),_:1},8,["rows","columns","filter","pagination"])])])}var ae=P(M,[["render",re]]);function ne(e,t,r,o){const a={items_drawn:{},cols:[-300,120,560]};$(e,t.initial_stage,t.stages[t.initial_stage],a,t,200,!1,r,o)}const w=130,y=400;function se(e,t,r){let o=0;return r?o=2:typeof e.draw_col!="undefined"&&(o=e.draw_col),t.cols[o]}function $(e,t,r,o,a,i,d,n,c){if(Object.keys(o.items_drawn).includes(t))return;const p=se(r,o,d),g=e.append("g").attr("transform","translate( "+p+" "+i+")");o.items_drawn[t]={pos_x:p,pos_y:i},ie(g,t,r,d,n,a,c),typeof r.progression!="undefined"&&(typeof r.progression.failed!="undefined"&&($(e,r.progression.failed,a.stages[r.progression.failed],o,a,i+150,!0,n,c),R(e,p,i+w,o.cols[2]-y/2,i+150+w/2)),typeof r.progression.success!="undefined"&&r.progression.success.forEach(function(_){$(e,_.next_stage,a.stages[_.next_stage],o,a,i+300,!1,n,c),R(e,p,i+w,o.items_drawn[_.next_stage].pos_x,o.items_drawn[_.next_stage].pos_y)}))}function R(e,t,r,o,a){e.append("line").attr("x1",t).attr("y1",r).attr("x2",o).attr("y2",a).attr("stroke","black").attr("style","stroke-width:10;").attr("marker-end","url(#triangle)")}function ie(e,t,r,o,a,i,d){const n=e.append("g");let c="lightgreen";o&&(c="pink");function p(){a(t,r)}let g=0;if(typeof d.workflow_lookup!="undefined"&&typeof d.workflow_lookup[i.id]!="undefined"&&typeof d.workflow_lookup[i.id][t]!="undefined"&&(g=d.workflow_lookup[i.id][t].length),n.append("rect").attr("width",y).attr("height",w).attr("x",-(y/2)).attr("y",0).attr("style","fill: "+c+";stroke-width:3;stroke:rgb(0,0,0)").on("click",p),n.append("text").attr("x",0).attr("y",50).attr("text-anchor","middle").style("font-size","28px").style("font-weight","500").text(r.name).on("click",p),n.append("text").attr("x",0).attr("y",110).attr("text-anchor","middle").style("font-size","56px").style("font-weight","500").text(g.toString()).on("click",p),typeof r.diagram_notes!="undefined"){let _=0;r.diagram_notes.split("<BR>").forEach(function(V){n.append("text").attr("x",-(y/2+20)).attr("y",_).attr("text-anchor","end").attr("alignment-baseline","text-before-edge").style("font-size","24px").style("font-weight","500").text(V),_=_+30})}}const le=C({name:"WorkflowChart",props:["patch_data"],emits:["onclickstage"],data(){return{allzoomedelements:void 0,boudaryRect:void 0,svg:void 0,background_item_group:void 0,chartarea:{xmin:-950,xmax:950,ymin:-150,ymax:2300}}},computed:{workflow(){return T.workflows[T.default_workflow_id]}},methods:{initChart(){for(var e=this,t=function(o){var a=800,i=800;o.svg=U("svg").attr("style","border: 1px solid black;position:fixed; top:0; left:0; height:100%; width:100%").attr("viewBox",[-a/2,-i/2,a,i]).attr("oncontextmenu","return false;"),o.allzoomedelements=o.svg.append("g"),e.boudaryRect=o.allzoomedelements.append("rect").attr("width",o.chartarea.xmax-o.chartarea.xmin).attr("height",o.chartarea.ymax-o.chartarea.ymin).attr("x",o.chartarea.xmin).attr("y",o.chartarea.ymin).attr("style","fill: white;stroke-width:3;stroke:rgb(0,0,0)"),o.svg.call(F().extent([[0,0],[a,i]]).scaleExtent([-5,10]).on("zoom",d)),o.svg.on("dblclick.zoom",null);function d(n,c){o.allzoomedelements.attr("transform",n.transform)}return o.allzoomedelements.append("text").attr("text-anchor","middle").attr("alignment-baseline","central").attr("x",0).attr("y",-70).attr("style","font-size: 60px; font-weight: 800;").text(n=>e.workflow.name),o.allzoomedelements.append("text").attr("text-anchor","middle").attr("alignment-baseline","central").attr("x",0).attr("y",-0).attr("style","font-size: 50px; font-weight: 300;").text(n=>"Projects for patch "+e.patch_data.name),o.allzoomedelements.append("text").attr("text-anchor","middle").attr("alignment-baseline","central").attr("x",0).attr("y",60).attr("style","font-size: 40px; font-weight: 300;").text(n=>"(Note: Diagram only - workflows not yet implemented)"),o.svg.node()},r=document.getElementById("chartInsetionPoint_workflowchart");r.firstChild;)console.log("Removing old SVG"),r.removeChild(r.firstChild);r.appendChild(t(this)),this.svg.append("marker").attr("id","triangle").attr("viewBox","0 0 10 10").attr("refX","8").attr("refY","5").attr("markerUnits","strokeWidth").attr("markerWidth","4").attr("markerHeight","4").attr("orient","auto").attr("fill","black").append("path").attr("d","M 0 0 L 10 5 L 0 10 z"),ne(this.allzoomedelements,this.workflow,this.click_stage_callback,this.patch_data)},click_stage_callback(e,t){this.$emit("onclickstage",this.workflow.id,e,t)},clickDIV(){}},mounted(){this.initChart()}});function de(e,t,r,o,a,i){return s(),l("div",{id:"chartInsetionPoint_workflowchart",onClick:t[0]||(t[0]=d=>e.clickDIV(d))})}var ce=P(le,[["render",de]]);const fe=C({name:"ToolsCansavePatchePage",components:{ProjectTable:ae,WrokflowChart:ce,TodoDisplay:G},setup(){return{backend_connection_store:B()}},data(){return{loaded:!1,patch_data:{},loaded_projects:[],filtered_loaded_projects:[],selected_stage:{workflow_id:void 0,stage_id:void 0},tab:"projects"}},watch:{loaded_projects(e){this.recompute_filtered_projects()}},computed:{isStageSelected(){return typeof this.selected_stage.workflow_id!="undefined"},selectedStageText(){return T.workflows[this.selected_stage.workflow_id].stages[this.selected_stage.stage_id].name},user_profile(){return this.backend_connection_store.user_profile}},methods:{recompute_filtered_projects(){const e=this;this.filtered_loaded_projects=this.loaded_projects.filter(function(t){return e.isStageSelected?typeof e.patch_data.workflow_lookup[e.selected_stage.workflow_id]=="undefined"||typeof e.patch_data.workflow_lookup[e.selected_stage.workflow_id][e.selected_stage.stage_id]=="undefined"?!1:e.patch_data.workflow_lookup[e.selected_stage.workflow_id][e.selected_stage.stage_id].filter(function(r){return t.id===r}).length>0:!0})},clearselectesstage(){this.selected_stage={workflow_id:void 0,stage_id:void 0},this.recompute_filtered_projects()},onchartclickstage(e,t,r){this.selected_stage={workflow_id:e,stage_id:t},this.recompute_filtered_projects(),this.tab="projects"},clicknewproject(){this.$router.push("/tools/brrcalc?patchid="+this.$route.params.patchid)},click_brrr_card(){this.$router.push("/tools/brrcalc")},refresh(){const e=this,t={ok:e.refresh_success,error:function(r){Q.create({color:"negative",message:"Failed to find patch information",timeout:2e3}),e.$router.push("/tools/cansave/patches")}};this.backend_connection_store.call_api({apiprefix:"privateUserAPIPrefix",url:"/patches/"+e.$route.params.patchid,method:"GET",data:void 0,callback:t})},refresh_success(e){this.patch_data=e.data,this.loaded_projects=this.patch_data.projects.map(function(t){return{id:t,loaded:!1,item:void 0}}),this.recursive_load_project_details(),this.loaded=!0},recursive_load_project_details(){const e=this.loaded_projects.filter(function(a){return a.loaded===!1});if(e.length===0)return;const t=e[0],r=this,o={ok:function(a){t.loaded=!0,t.item=a.data,r.recompute_filtered_projects(),r.recursive_load_project_details()},error:function(a){t.loaded=!0,t.address="TODO LOAD FAIL",r.recursive_load_project_details()}};this.backend_connection_store.call_api({apiprefix:"privateUserAPIPrefix",url:"/projects/"+t.id,method:"GET",data:void 0,callback:o})}},mounted(){this.loaded=!1,this.refresh()}}),ue={key:0},pe=h("h1",null,"Loading...",-1),_e=[pe],me={key:1},he={key:0},ge={key:2},ke=h("h2",null,"Projects",-1),we={key:0,class:"selected_stage"},ye={key:3},be={key:4};function ve(e,t,r,o,a,i){const d=k("ProjectTable"),n=k("TodoDisplay"),c=k("WrokflowChart");return s(),S(W,{class:"patchpageclass"},{default:m(()=>[e.loaded?f("",!0):(s(),l("div",ue,_e)),e.loaded?(s(),l("div",me,[e.tab!=="workflow"?(s(),l("h1",he,b(e.patch_data.name),1)):f("",!0),e.tab!=="workflow"?(s(),S(j,{key:1,modelValue:e.tab,"onUpdate:modelValue":t[0]||(t[0]=p=>e.tab=p),dense:"",class:"text-grey","active-color":"primary","indicator-color":"primary",align:"justify","narrow-indicator":""},{default:m(()=>[u(x,{name:"projects",label:"Projects"}),u(x,{name:"todos",label:"Todos"}),u(x,{name:"workflow",label:"Workflow"})]),_:1},8,["modelValue"])):f("",!0),e.tab==="projects"?(s(),l("div",ge,[ke,e.isStageSelected?(s(),l("div",we,[v(" Stage "+b(e.selectedStageText)+" ",1),u(z,{color:"primary",icon:"close",round:"",onClick:e.clearselectesstage},null,8,["onClick"])])):f("",!0),h("div",null,[u(d,{projects:e.filtered_loaded_projects,prefiltered:e.isStageSelected},null,8,["projects","prefiltered"])]),u(z,{color:"primary",label:"Add Project",onClick:e.clicknewproject},null,8,["onClick"])])):f("",!0),e.tab==="todos"?(s(),l("div",ye,[u(n,{patch_id:e.patch_data.id},null,8,["patch_id"])])):f("",!0),e.tab==="workflow"?(s(),l("div",be,[u(c,{patch_data:e.patch_data,onOnclickstage:e.onchartclickstage},null,8,["patch_data","onOnclickstage"])])):f("",!0)])):f("",!0)]),_:1})}var We=P(fe,[["render",ve]]);export{We as default};
