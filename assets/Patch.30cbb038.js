import{Q as x,a as z}from"./QTabs.3a120950.js";import{a2 as ee,d as B,_ as E,o as c,K as u,g as te,ax as oe,au as se,k as G,q as A,x as U,u as re,a as l,w as d,f as y,t as v,aa as I,ae as j,ai as P,Q as h,e as _,M as R,O as S,ag as W,aj as N,N as q,r as C,c as V,ak as ae,L as p,af as le,a9 as ne}from"./index.ce16cc00.js";import{Q as ie}from"./QPage.5b728a67.js";import{u as Q}from"./backend_connection.15cca581.js";import{u as L}from"./data_caches.e9d63034.js";import{W as k}from"./Workflow_main.1e4e793e.js";import{u as D}from"./utils.99aafcb0.js";import{Q as H,a as K}from"./QItemSection.58b3832f.js";import{Q as ce}from"./QList.7facff1a.js";import{Q as de}from"./QPopupProxy.ffb88a64.js";import{b as X,Q as _e}from"./QTable.d8eed38c.js";import{C as F}from"./ClosePopup.97901618.js";import{C as ue}from"./CommonBRRToolLink.4b81da5a.js";import{a as O}from"./QSelect.59f2341e.js";import{Q as M}from"./QSpace.c61c4dca.js";import{c as fe,z as ge}from"./zoom.2619b28f.js";import{T as he}from"./TodoDisplay.af208e71.js";import{f as pe}from"./featureflags.2c595d38.js";import"./QResizeObserver.9c0f3afe.js";import"./axios.6e1fcf85.js";import"./QMenu.d142a400.js";import"./position-engine.4214c75f.js";import"./use-fullscreen.3b80e849.js";import"./QItemLabel.2c96e18d.js";import"./TodoItem.54e8fb76.js";import"./common_constants.94b43302.js";function me(e){return{purchase:{cumulatively_loaded_stages:{},cumulatively_loaded_sources:{},cumulatively_loaded_agents:{}},rent:{cumulatively_loaded_stages:{},cumulatively_loaded_sources:{},cumulatively_loaded_agents:{}}}}const ke=ee("cumulatively_loaded_stages",{state:()=>({value:{}}),getters:{none(e){}},actions:{_createPatchRecordIfRequired(e){Object.keys(this.value).includes(e)||(this.value[e]=me())},findPatchRecord(e){return this._createPatchRecordIfRequired(e),this.value[e]},reportFoundStage({type:e,patch_id:t,workflow_stage_id:o,workflow_id:s,stage_id:a,stage:n,stage_selected:r}){this._createPatchRecordIfRequired(t),o in this.value[t][e].cumulatively_loaded_stages||(this.value[t][e].cumulatively_loaded_stages[o]={workflow_stage_id:o,workflow_id:s,stage_id:a,stage:n,selected:r})},reportFoundProject({type:e,patch_id:t,workflow_stage_id:o,workflow_id:s,stage_id:a,stage:n,stage_selected:r,source:i,source_selected:f,agent:g,agent_selected:m}){this.reportFoundStage({type:e,patch_id:t,workflow_stage_id:o,workflow_id:s,stage_id:a,stage:n,stage_selected:r}),i in this.value[t][e].cumulatively_loaded_sources||(this.value[t][e].cumulatively_loaded_sources[i]={name:i,selected:f}),g in this.value[t][e].cumulatively_loaded_agents||(this.value[t][e].cumulatively_loaded_agents[g]={name:g,selected:m})}}});function be(e){return e.type==="purchase"?typeof e.sub_section_details.dealbasicinfo.postcode!="undefined"?e.sub_section_details.dealbasicinfo.address+", "+e.sub_section_details.dealbasicinfo.postcode:e.sub_section_details.dealbasicinfo.address:typeof e.sub_section_details.leadinformation.postcode!="undefined"?e.sub_section_details.leadinformation.address+", "+e.sub_section_details.leadinformation.postcode:e.sub_section_details.leadinformation.address}function ye(e){return e.type==="purchase"?D.get_source_text(e.sub_section_details.dealbasicinfo.deal_source):e.sub_section_details.leadinformation.lead_source}function we(e,t){if(e.type==="purchase"){if(typeof e.sub_section_details.dealbasicinfo.selling_agent_id=="undefined")return D.get_agent_text(e.sub_section_details.dealbasicinfo.selling_agent);if(e.sub_section_details.dealbasicinfo.selling_agent_id==="")return D.get_agent_text(e.sub_section_details.dealbasicinfo.selling_agent);const o=t.get_direct_from_cache({object_type:"patchagents",object_id:e.patch_id});return typeof o=="undefined"||typeof o.agents=="undefined"||typeof o.agents[e.sub_section_details.dealbasicinfo.selling_agent_id]=="undefined"?"":o.agents[e.sub_section_details.dealbasicinfo.selling_agent_id].agent_name+" (\u{1F4CB})"}return""}function ve(e){return e.type==="purchase"?e.sub_section_details.vision.devplan:""}function je(e){return e.type==="purchase"?e.sub_section_details.dealbasicinfo.notes:""}var w={address:be,dealsource:ye,sellingAgent:we,devplan:ve,notes:je};const Ce=function(e){return w.dealsource(e)},$e=function(e,t){return w.sellingAgent(e,t)},Te=B({name:"ProjectData",setup(){const e=Q(),t=ke(),o=L();return{backend_connection_store:e,patch_local_settings_store:t,dataCachesStore:o}},props:["project_type"],data(){return{loaded_projects:[],filtered_loaded_projects:[],project_filter:{filter_stages:!0,selected_stages:[],filter_agents:!0,selected_agents:[],filter_sources:!0,selected_sources:[]},patch_id:void 0,get_cur_filter_fn:void 0,get_source_text_fn:Ce,get_agent_text_fn:$e}},watch:{loaded_projects(e){this.recompute_filtered_projects()}},computed:{cumulatively_loaded_stages:{get(){return this.patch_local_settings_store.findPatchRecord(this.patch_id)[this.project_type].cumulatively_loaded_stages}},cumulatively_loaded_sources:{get(){return this.patch_local_settings_store.findPatchRecord(this.patch_id)[this.project_type].cumulatively_loaded_sources}},cumulatively_loaded_agents:{get(){return this.patch_local_settings_store.findPatchRecord(this.patch_id)[this.project_type].cumulatively_loaded_agents}}},methods:{projecttablefilterchanged(e){typeof e=="undefined"?(this.project_filter.filter_stages=!1,this.project_filter.selected_stages=[],this.project_filter.filter_agents=!1,this.project_filter.selected_agents=[],this.project_filter.filter_sources=!1,this.project_filter.selected_sources=[]):(this.project_filter.filter_stages=!0,this.project_filter.selected_stages=e.selected_stages,this.project_filter.filter_agents=!0,this.project_filter.selected_agents=e.selected_agents,this.project_filter.filter_sources=!0,this.project_filter.selected_sources=e.selected_sources),this.recompute_filtered_projects()},_recompute_filtered_projects_stage_filter(e){if(!this.project_filter.filter_stages)return!0;const t=k.get_workflow_stage_key(e.item.workflow.workflow_used_id,e.item.workflow.current_stage);return!!this.project_filter.selected_stages.includes(t)},_recompute_filtered_projects_agent_filter(e){if(!this.project_filter.filter_agents)return!0;const t=this.get_agent_text_fn(e.item,this.dataCachesStore);return!!this.project_filter.selected_agents.includes(t)},_recompute_filtered_projects_source_filter(e){if(!this.project_filter.filter_sources)return!0;const t=this.get_source_text_fn(e.item);return!!this.project_filter.selected_sources.includes(t)},is_project_included_in_current_filters(e){return this._recompute_filtered_projects_stage_filter(e)?e.loaded?!(!this._recompute_filtered_projects_agent_filter(e)||!this._recompute_filtered_projects_source_filter(e)):!0:!1},recompute_filtered_projects(){const e=this;this.filtered_loaded_projects=this.loaded_projects.filter(function(t){return e.is_project_included_in_current_filters(t)})},refresh({project_info_to_load:e,patch_id:t,get_cur_filter_fn:o,workflows:s}){const a=this;this.get_cur_filter_fn=o,this.patch_id=t,this.loaded_projects=e.map(function(r){const i=k.get_workflow_stage_key(r.workflow_id,r.stage_id);return a.patch_local_settings_store.reportFoundStage({type:a.project_type,patch_id:a.patch_id,workflow_stage_id:i,workflow_id:r.workflow_id,stage_id:r.stage_id,stage:k.getWorkflowStage(s,r.workflow_id,r.stage_id),stage_selected:D.boolean_undefined_to_false(s[r.workflow_id].stages[r.stage_id].active)}),{id:r.project_id,loaded:!1,item:{workflow:{workflow_used_id:r.workflow_id,current_stage:r.stage_id}}}});const n={ok:function(r){a.recursive_load_project_details(s)},error:function(r){console.log("Error when getting agent data for patch")}};a.dataCachesStore.get({backend_connection_store:this.backend_connection_store,object_type:"patchagents",object_id:t,skip_cache:!1,callback:n})},_get_next_item_to_load(){const e=this,t=this.loaded_projects.filter(function(s){return s.loaded?!1:e.is_project_included_in_current_filters(s)});if(t.length!==0)return t[0];const o=this.loaded_projects.filter(function(s){return s.loaded!==!0});if(o.length!==0)return o[0]},recursive_load_project_details(e){const t=this._get_next_item_to_load();if(typeof t=="undefined")return;const o=this,s={ok:function(a){t.loaded=!0,t.item=a.data,o.add_to_cumulatively_loaded(a.data,e),o.projecttablefilterchanged(o.get_cur_filter_fn()),o.recompute_filtered_projects(),o.recursive_load_project_details(e)},error:function(a){t.loaded=!0,t.address="TODO LOAD FAIL",o.recursive_load_project_details(e)}};this.dataCachesStore.get({backend_connection_store:this.backend_connection_store,object_type:"projects",object_id:t.id,skip_cache:!1,callback:s})},add_to_cumulatively_loaded(e,t){const o=k.get_workflow_stage_key(e.workflow.workflow_used_id,e.workflow.current_stage),s=this.get_source_text_fn(e),a=this.get_agent_text_fn(e,this.dataCachesStore);this.patch_local_settings_store.reportFoundProject({type:this.project_type,patch_id:this.patch_id,workflow_stage_id:o,workflow_id:e.workflow.workflow_used_id,stage_id:e.workflow.current_stage,stage:k.getWorkflowStage(t,e.workflow.workflow_used_id,e.workflow.current_stage),stage_selected:D.boolean_undefined_to_false(t[e.workflow.workflow_used_id].stages[e.workflow.current_stage].active),source:s,source_selected:!0,agent:a,agent_selected:!0})}}});function Pe(e,t,o,s,a,n){return c(),u("div")}var Re=E(Te,[["render",Pe]]),Se=te({name:"QBanner",props:{...oe,inlineActions:Boolean,dense:Boolean,rounded:Boolean},setup(e,{slots:t}){const{proxy:{$q:o}}=re(),s=se(e,o),a=G(()=>"q-banner row items-center"+(e.dense===!0?" q-banner--dense":"")+(s.value===!0?" q-banner--dark q-dark":"")+(e.rounded===!0?" rounded-borders":"")),n=G(()=>`q-banner__actions row items-center justify-end col-${e.inlineActions===!0?"auto":"all"}`);return()=>{const r=[A("div",{class:"q-banner__avatar col-auto row items-center self-start"},U(t.avatar)),A("div",{class:"q-banner__content col text-body2"},U(t.default))],i=U(t.action);return i!==void 0&&r.push(A("div",{class:n.value},i)),A("div",{class:a.value+(e.inlineActions===!1&&i!==void 0?" q-banner--top-padding":""),role:"alert"},r)}}});const Ve=B({name:"ProjectTableFilterComponent",props:["projects","cumulatively_loaded_stages","cumulatively_loaded_agents","cumulatively_loaded_sources"],emits:["filterchanged"],components:{},setup(){return{backend_connection_store:Q()}},data(){return{dialog_stages:!1,dialog_sources:!1,dialog_agents:!1}},computed:{stages(){const e=this;let t=[];return Object.keys(e.cumulatively_loaded_stages).forEach(function(o){t.push(e.cumulatively_loaded_stages[o])}),t},agents(){const e=this;let t=[];return Object.keys(e.cumulatively_loaded_agents).forEach(function(o){t.push(e.cumulatively_loaded_agents[o])}),t},sources(){const e=this;let t=[];return Object.keys(e.cumulatively_loaded_sources).forEach(function(o){t.push(e.cumulatively_loaded_sources[o])}),t},filter_stages_options(){return[{label:"Call Agent",value:"agent"},{label:"Call Sourcer",value:"sourcer"},{label:"Other",value:"other"}]},isStageSelected(e){return!0}},methods:{close_all_dialogs(){this.dialog_stages=!1,this.dialog_agents=!1,this.dialog_sources=!1},click_filter_chip(e){if(this.close_all_dialogs(),e==="Stages"){this.dialog_stages=!0;return}if(e==="Agents"){this.dialog_agents=!0;return}this.dialog_sources=!0},_isFiltered(e){return e.filter(function(o){return!o.selected}).length>0},isFiltered(e){return e==="Stages"?this._isFiltered(this.stages):e==="Sources"?this._isFiltered(this.sources):this._isFiltered(this.agents)},onlyActiveShowing(){let e=!0;return this.stages.forEach(function(t){t.stage.active?t.selected||(e=!1):t.selected&&(e=!1)}),e},filter_text(e){return e==="Stages"&&this.onlyActiveShowing()?"Filter: Active Stages":this.isFiltered(e)?"Filter: "+e:"Filter: "+e+" - not filtered"},set_selected_stages(e){this.stages.forEach(function(t){e.includes(t.workflow_stage_id)?t.selected=!0:t.selected=!1}),this.agents.forEach(function(t){t.selected=!0}),this.sources.forEach(function(t){t.selected=!0}),this.emit_filter_changed_signal()},get_current_filter(){let e=[];this.stages.forEach(function(s){s.selected&&e.push(s.workflow_stage_id)});let t=[];this.agents.forEach(function(s){s.selected&&t.push(s.name)});let o=[];return this.sources.forEach(function(s){s.selected&&o.push(s.name)}),{selected_stages:e,selected_agents:t,selected_sources:o}},emit_filter_changed_signal(){this.$emit("filterchanged",this.get_current_filter())},click_stages_select_none(){this.stages.forEach(function(e){e.selected=!1}),this.emit_filter_changed_signal()},click_stages_select_all(){this.stages.forEach(function(e){e.selected=!0}),this.emit_filter_changed_signal()},click_agents_select_none(){this.agents.forEach(function(e){e.selected=!1}),this.emit_filter_changed_signal()},click_agents_select_all(){this.agents.forEach(function(e){e.selected=!0}),this.emit_filter_changed_signal()},click_sources_select_none(){this.sources.forEach(function(e){e.selected=!1}),this.emit_filter_changed_signal()},click_sources_select_all(){this.sources.forEach(function(e){e.selected=!0}),this.emit_filter_changed_signal()},click_stages_select_active(){this.stages.forEach(function(e){let t=!1;typeof e.stage.active!="undefined"&&(t=e.stage.active),e.selected=t}),this.emit_filter_changed_signal()}},mounted(){}}),Fe=_("div",{class:"text-h6"},"Filter Stages",-1),De={class:"col project_table_filters_any_filter"},Be={class:"row"},Ee={class:"row"},Qe={class:"project_table_filters_any_filter_button"},Ae={class:"project_table_filters_any_filter_button"},qe={class:"project_table_filters_any_filter_button"},Le={class:"project_table_filters_any_filter_button"},ze=_("div",{class:"text-h6"},"Filter Agents",-1),Ue={class:"row project_table_filters_any_filter"},Ie={class:"project_table_filters_any_filter_button"},We={class:"project_table_filters_any_filter_button"},Ne={class:"project_table_filters_any_filter_button"},Oe=_("div",{class:"text-h6"},"Filter Sources",-1),Me={class:"row project_table_filters_any_filter"},Ye={class:"project_table_filters_any_filter_button"},Ge={class:"project_table_filters_any_filter_button"},He={class:"project_table_filters_any_filter_button"};function Ke(e,t,o,s,a,n){return c(),u("div",null,[l(O,{clickable:"",onClick:t[0]||(t[0]=r=>e.click_filter_chip("Stages")),removable:e.isFiltered("Stages"),onRemove:e.click_stages_select_all,color:"primary","text-color":"white","icon-remove":"close"},{default:d(()=>[y(v(e.filter_text("Stages")),1)]),_:1},8,["removable","onRemove"]),l(O,{clickable:"",onClick:t[1]||(t[1]=r=>e.click_filter_chip("Agents")),removable:e.isFiltered("Agents"),onRemove:e.click_agents_select_all,color:"primary","text-color":"white","icon-remove":"close"},{default:d(()=>[y(v(e.filter_text("Agents")),1)]),_:1},8,["removable","onRemove"]),l(O,{clickable:"",onClick:t[2]||(t[2]=r=>e.click_filter_chip("Sources")),removable:e.isFiltered("Sources"),onRemove:e.click_sources_select_all,color:"primary","text-color":"white","icon-remove":"close"},{default:d(()=>[y(v(e.filter_text("Sources")),1)]),_:1},8,["removable","onRemove"]),l(N,{modelValue:e.dialog_stages,"onUpdate:modelValue":t[3]||(t[3]=r=>e.dialog_stages=r)},{default:d(()=>[l(I,{class:"todoitem-dialogcard"},{default:d(()=>[l(j,{class:"row items-center q-pb-none"},{default:d(()=>[Fe,l(M),P(l(h,{icon:"close",flat:"",round:"",dense:""},null,512),[[F]])]),_:1}),l(j,null,{default:d(()=>[_("div",De,[_("div",Be,[(c(!0),u(R,null,S(e.stages,r=>(c(),u("div",{key:r.workflow_stage_id},[l(W,{modelValue:r.selected,"onUpdate:modelValue":i=>r.selected=i,label:r.stage.name,onClick:e.emit_filter_changed_signal},null,8,["modelValue","onUpdate:modelValue","label","onClick"])]))),128))]),_("div",Ee,[_("div",Qe,[l(h,{color:"primary",label:"Select all",onClick:e.click_stages_select_all},null,8,["onClick"])]),_("div",Ae,[l(h,{color:"primary",label:"Select none",onClick:e.click_stages_select_none},null,8,["onClick"])]),_("div",qe,[l(h,{color:"primary",label:"Select active",onClick:e.click_stages_select_active},null,8,["onClick"])]),_("div",Le,[l(h,{color:"secondary",label:"Close",onClick:e.close_all_dialogs},null,8,["onClick"])])])])]),_:1})]),_:1})]),_:1},8,["modelValue"]),l(N,{modelValue:e.dialog_agents,"onUpdate:modelValue":t[4]||(t[4]=r=>e.dialog_agents=r)},{default:d(()=>[l(I,{class:"todoitem-dialogcard"},{default:d(()=>[l(j,{class:"row items-center q-pb-none"},{default:d(()=>[ze,l(M),P(l(h,{icon:"close",flat:"",round:"",dense:""},null,512),[[F]])]),_:1}),l(j,null,{default:d(()=>[_("div",Ue,[(c(!0),u(R,null,S(e.agents,r=>(c(),u("div",{key:r.name},[l(W,{modelValue:r.selected,"onUpdate:modelValue":i=>r.selected=i,label:r.name,onClick:e.emit_filter_changed_signal},null,8,["modelValue","onUpdate:modelValue","label","onClick"])]))),128)),_("div",Ie,[l(h,{color:"primary",label:"Select all",onClick:e.click_agents_select_all},null,8,["onClick"])]),_("div",We,[l(h,{color:"primary",label:"Select none",onClick:e.click_agents_select_none},null,8,["onClick"])]),_("div",Ne,[l(h,{color:"secondary",label:"Close",onClick:e.close_all_dialogs},null,8,["onClick"])])])]),_:1})]),_:1})]),_:1},8,["modelValue"]),l(N,{modelValue:e.dialog_sources,"onUpdate:modelValue":t[5]||(t[5]=r=>e.dialog_sources=r)},{default:d(()=>[l(I,{class:"todoitem-dialogcard"},{default:d(()=>[l(j,{class:"row items-center q-pb-none"},{default:d(()=>[Oe,l(M),P(l(h,{icon:"close",flat:"",round:"",dense:""},null,512),[[F]])]),_:1}),l(j,null,{default:d(()=>[_("div",Me,[(c(!0),u(R,null,S(e.sources,r=>(c(),u("div",{key:r.name},[l(W,{modelValue:r.selected,"onUpdate:modelValue":i=>r.selected=i,label:r.name,onClick:e.emit_filter_changed_signal},null,8,["modelValue","onUpdate:modelValue","label","onClick"])]))),128)),_("div",Ye,[l(h,{color:"primary",label:"Select all",onClick:e.click_sources_select_all},null,8,["onClick"])]),_("div",Ge,[l(h,{color:"primary",label:"Select none",onClick:e.click_sources_select_none},null,8,["onClick"])]),_("div",He,[l(h,{color:"secondary",label:"Close",onClick:e.close_all_dialogs},null,8,["onClick"])])])]),_:1})]),_:1})]),_:1},8,["modelValue"])])}var Xe=E(Ve,[["render",Ke]]);const Je=B({name:"ToolsCansavePatchePage",props:["projects","prefiltered","cumulatively_loaded_stages","cumulatively_loaded_agents","cumulatively_loaded_sources"],emits:["filterchanged","onRowClick","refresh_button"],components:{CommonBRRToolLink:ue,ProjectTableFilters:Xe},setup(){const e=Q(),t=L();return{backend_connection_store:e,dataCachesStore:t}},data(){return{loaded:!1,workflows:void 0,filter:"",columns:[{name:"address",required:!0,label:"Address",align:"left",field:"address",sortable:!0},{name:"workflowstage",required:!0,label:"Stage",align:"left",field:"stage",sortable:!0},{name:"visionandnotes",required:!0,label:"Vision and Notes",align:"left",field:"vandnotes",sortable:!1},{name:"source",required:!0,label:"Source",align:"left",field:"source",sortable:!0},{name:"agent",required:!0,label:"Agent",align:"left",field:"selling_agent",sortable:!0},{name:"todo",required:!0,label:"Todos",align:"left",field:"todo",sortable:!1}],initialPagination:{rowsPerPage:50}}},computed:{filter_stages_options(){return[{label:"Call Agent",value:"agent"},{label:"Call Sourcer",value:"sourcer"},{label:"Other",value:"other"}]},user_profile(){return this.backend_connection_store.user_profile},table_content(){const e=this;return this.projects.map(function(t){return t.loaded?{id:t.id,loaded:t.loaded,address:w.address(t.item),source:e.get_source_text(t.item),selling_agent:w.sellingAgent(t.item,e.dataCachesStore),vandnotes:"NOT DISPLAYED",devplan:w.devplan(t.item),notes:w.notes(t.item),stage:e.getWorkflowStage(t.item.workflow).name,todo:e.get_todo_text(t)}:{id:t.id,loaded:!1,address:"Loading...",source:"",selling_agent:"",vandnotes:"",devplan:"",notes:"",stage:e.getWorkflowStage(t.item.workflow).name,todo:""}})}},methods:{get_current_filter(){return this.$refs.ProjectTableFilters.get_current_filter()},set_selected_stages(e){this.$refs.ProjectTableFilters.set_selected_stages(e)},get_todo_text(e){let t=0,o=0,s=0;return typeof e.item.todos!="undefined"&&(t=e.item.todos.filter(function(a){return!a.done&&!a.due}).length,o=e.item.todos.filter(function(a){return!a.done&&a.due}).length,s=e.item.todos.filter(function(a){return a.done}).length),o.toString()+"/"+(t+o).toString()+" ("+s.toString()+")"},get_source_text(e){return w.dealsource(e)},getWorkflowStage({workflow_used_id:e,current_stage:t}){return this.workflows[e].stages[t]}},mounted(){this.loaded=!1;const e=this,t={ok:function(o){e.workflows=o,e.loaded=!0,setTimeout(function(){e.$refs.ProjectTableFilters.emit_filter_changed_signal()},50)},error:function(o){q.create({color:"bg-grey-2",message:"Unable to load workflow information",timeout:2e3,color:"negative"})}};k.workflow3(this.backend_connection_store,this.dataCachesStore,t)}}),Ze={key:0,class:"projecttablecontainer"},xe={class:"projecttablestyle"},et={class:"row"},tt={class:"col-grow"},ot=_("th",{align:"left"},[y("Todo"),_("br"),y("due/total (done)")],-1),st={key:0},rt={key:0},at={key:1},lt={key:0},nt={key:0},it={key:1},ct={key:1};function dt(e,t,o,s,a,n){const r=C("ProjectTableFilters"),i=C("CommonBRRToolLink");return e.loaded?(c(),u("div",Ze,[_("div",xe,[_("div",et,[_("div",tt,[l(r,{ref:"ProjectTableFilters",projects:e.projects,cumulatively_loaded_stages:e.cumulatively_loaded_stages,cumulatively_loaded_agents:e.cumulatively_loaded_agents,cumulatively_loaded_sources:e.cumulatively_loaded_sources,onFilterchanged:t[0]||(t[0]=f=>e.$emit("filterchanged",f))},null,8,["projects","cumulatively_loaded_stages","cumulatively_loaded_agents","cumulatively_loaded_sources"])]),l(h,{icon:"refresh",flat:"",round:"",dense:"",onClick:t[1]||(t[1]=()=>e.$emit("refresh_button"))})]),l(_e,{flat:"",bordered:"",title:"Projects",rows:e.table_content,columns:e.columns,filter:e.filter,pagination:e.initialPagination,"no-data-label":"I didn't find anything for you","no-results-label":"The filter didn't uncover any results","row-key":"name",onRowClick:t[3]||(t[3]=(f,g,m)=>e.$emit("onRowClick",{table_row:g,new_tab:!1}))},{"header-cell-todo":d(()=>[ot]),"body-cell-address":d(f=>[l(X,null,{default:d(()=>[l(de,{"context-menu":""},{default:d(()=>[l(Se,null,{default:d(()=>[l(ce,{style:{"min-width":"100px"}},{default:d(()=>[P((c(),V(K,{clickable:"",onClick:()=>e.$emit("onRowClick",{table_row:f.row,new_tab:!0})},{default:d(()=>[l(H,null,{default:d(()=>[y("Open in new tab...")]),_:1})]),_:2},1032,["onClick"])),[[F]]),l(ae),P((c(),V(K,{clickable:""},{default:d(()=>[l(H,null,{default:d(()=>[y("Cancel")]),_:1})]),_:1})),[[F]])]),_:2},1024)]),_:2},1024)]),_:2},1024),y(" "+v(f.row.address),1)]),_:2},1024)]),"body-cell-visionandnotes":d(f=>[l(X,null,{default:d(()=>[f.row.loaded?(c(),u("div",st,[typeof f.row.devplan!="undefined"?(c(),u("div",rt,[(c(!0),u(R,null,S(f.row.devplan.split(`
`),g=>(c(),u("div",{key:g,class:"projecttablehead"},v(g),1))),128))])):p("",!0),typeof f.row.notes!="undefined"?(c(),u("div",at,[(c(!0),u(R,null,S(f.row.notes.split(`
`),g=>(c(),u("div",{key:g},v(g),1))),128))])):p("",!0)])):p("",!0)]),_:2},1024)]),"top-right":d(()=>[l(le,{borderless:"",dense:"",debounce:"300",modelValue:e.filter,"onUpdate:modelValue":t[2]||(t[2]=f=>e.filter=f),clearable:"",placeholder:"Search"},{append:d(()=>[l(ne,{name:"search"})]),_:1},8,["modelValue"])]),"no-data":d(({})=>[e.prefiltered?p("",!0):(c(),u("div",lt,[e.projects.length===0?(c(),u("div",nt,[y(" No projects in this patch - use the BRR calculator to create one "),l(i)])):p("",!0),e.projects.length!==0?(c(),u("div",it," No projects match the filter ")):p("",!0)])),e.prefiltered?(c(),u("div",ct," No projects match the filter ")):p("",!0)]),_:1},8,["rows","columns","filter","pagination"])])])):p("",!0)}var _t=E(Je,[["render",dt]]);const $=130,T=400,ut=50;function ft(e,t){let o=[];return Object.keys(e.stages).forEach(function(s){if(s!==t){const a=e.stages[s];typeof a.progression!="undefined"&&(typeof a.progression.failed!="undefined"&&a.progression.failed===t&&o.push(s),typeof a.progression.success!="undefined"&&a.progression.success.forEach(function(n){n.next_stage===t&&o.push(s)}))}}),[...new Set(o)]}function gt(e){let t={};return Object.keys(e.stages).forEach(function(o){e.stages[o],t[o]=ft(e,o)}),t}function ht(e,t,o,s){const a={items_drawn:{},cols:[-300,120,560],incomming_stage_map:gt(t)},n=e.append("g"),r=e.append("g");Y(r,t.initial_stage,t.stages[t.initial_stage],a,t,200,!1,o,s),pt(n,t,a)}function pt(e,t,o){Object.keys(t.stages).forEach(function(s){const a=t.stages[s];if(typeof a.active!="undefined"&&a.active&&typeof a.progression!="undefined"&&typeof a.progression.failed!="undefined"){t.stages[a.progression.failed];const n=o.items_drawn[s],r=o.items_drawn[a.progression.failed];J(e,n.pos_x,n.pos_y+$,r.pos_x-T/2,r.pos_y+$/2)}})}function mt(e,t,o){let s=0;return o?s=2:typeof e.draw_col!="undefined"&&(s=e.draw_col),t.cols[s]}function kt(e,t){let o=!0;return t.incomming_stage_map[e].forEach(function(s){typeof t.items_drawn[s]=="undefined"&&(o=!1)}),o}function Y(e,t,o,s,a,n,r,i,f){if(Object.keys(s.items_drawn).includes(t))return;const g=mt(o,s,r),m=e.append("g").attr("transform","translate( "+g+" "+n+")");s.items_drawn[t]={pos_x:g,pos_y:n},yt(m,t,o,r,i,a,f),typeof o.progression!="undefined"&&(typeof o.progression.failed!="undefined"&&kt(t,s)&&Y(e,o.progression.failed,a.stages[o.progression.failed],s,a,n+150,!0,i,f),typeof o.progression.success!="undefined"&&o.progression.success.forEach(function(b){Y(e,b.next_stage,a.stages[b.next_stage],s,a,n+300,!1,i,f),n<s.items_drawn[b.next_stage].pos_y?J(e,g,n+$,s.items_drawn[b.next_stage].pos_x,s.items_drawn[b.next_stage].pos_y):bt(e,g+T/2,n+$/2,s.items_drawn[b.next_stage].pos_x+T/2,s.items_drawn[b.next_stage].pos_y+$/2,ut)}))}function J(e,t,o,s,a){e.append("line").attr("x1",t).attr("y1",o).attr("x2",s).attr("y2",a).attr("stroke","black").attr("style","stroke-width:10;").attr("marker-end","url(#triangle)")}function bt(e,t,o,s,a,n){let r=s;t>s&&(r=t),r+=n,e.append("line").attr("x1",t).attr("y1",o).attr("x2",r).attr("y2",o).attr("stroke","black").attr("style","stroke-width:10;"),e.append("line").attr("x1",r).attr("y1",o).attr("x2",r).attr("y2",a).attr("stroke","black").attr("style","stroke-width:10;"),e.append("line").attr("x1",r).attr("y1",a).attr("x2",s).attr("y2",a).attr("stroke","black").attr("style","stroke-width:10;").attr("marker-end","url(#triangle)")}function yt(e,t,o,s,a,n,r){const i=e.append("g");let f="lightgreen";s&&(f="pink");function g(){a(t,o)}let m=0;if(typeof r.workflow_lookup!="undefined"&&typeof r.workflow_lookup[n.id]!="undefined"&&typeof r.workflow_lookup[n.id][t]!="undefined"&&(m=r.workflow_lookup[n.id][t].length),i.append("rect").attr("width",T).attr("height",$).attr("x",-(T/2)).attr("y",0).attr("style","fill: "+f+";stroke-width:3;stroke:rgb(0,0,0)").on("click",g),i.append("text").attr("x",0).attr("y",50).attr("text-anchor","middle").style("font-size","28px").style("font-weight","500").text(o.name).on("click",g),i.append("text").attr("x",0).attr("y",110).attr("text-anchor","middle").style("font-size","56px").style("font-weight","500").text(m.toString()).on("click",g),typeof o.diagram_notes!="undefined"){let b=0;o.diagram_notes.split("<BR>").forEach(function(Z){i.append("text").attr("x",-(T/2+20)).attr("y",b).attr("text-anchor","end").attr("alignment-baseline","text-before-edge").style("font-size","24px").style("font-weight","500").text(Z),b=b+30})}}const wt=B({name:"WorkflowChart",props:["patch_data","workflow_id"],emits:["onclickstage"],setup(){const e=Q(),t=L();return{backend_connection_store:e,dataCachesStore:t}},data(){return{workflow:void 0,allzoomedelements:void 0,boudaryRect:void 0,svg:void 0,background_item_group:void 0,chartarea:{xmin:-950,xmax:950,ymin:-150,ymax:2500}}},computed:{},methods:{initChart(){for(var e=this,t=function(s){var a=800,n=800;s.svg=fe("svg").attr("style","border: 1px solid black;position:fixed; top:0; left:0; height:100%; width:100%").attr("viewBox",[-a/2,-n/2,a,n]).attr("oncontextmenu","return false;"),s.allzoomedelements=s.svg.append("g"),e.boudaryRect=s.allzoomedelements.append("rect").attr("width",s.chartarea.xmax-s.chartarea.xmin).attr("height",s.chartarea.ymax-s.chartarea.ymin).attr("x",s.chartarea.xmin).attr("y",s.chartarea.ymin).attr("style","fill: white;stroke-width:3;stroke:rgb(0,0,0)"),s.svg.call(ge().extent([[0,0],[a,n]]).scaleExtent([-5,10]).on("zoom",r)),s.svg.on("dblclick.zoom",null);function r(i,f){s.allzoomedelements.attr("transform",i.transform)}return s.allzoomedelements.append("text").attr("text-anchor","middle").attr("alignment-baseline","central").attr("x",0).attr("y",-70).attr("style","font-size: 60px; font-weight: 800;").text(i=>e.workflow.name),s.allzoomedelements.append("text").attr("text-anchor","middle").attr("alignment-baseline","central").attr("x",0).attr("y",-0).attr("style","font-size: 50px; font-weight: 300;").text(i=>"Projects for patch "+e.patch_data.name),s.svg.node()},o=document.getElementById("chartInsetionPoint_workflowchart");o.firstChild;)console.log("Removing old SVG"),o.removeChild(o.firstChild);o.appendChild(t(this)),this.svg.append("marker").attr("id","triangle").attr("viewBox","0 0 10 10").attr("refX","8").attr("refY","5").attr("markerUnits","strokeWidth").attr("markerWidth","4").attr("markerHeight","4").attr("orient","auto").attr("fill","black").append("path").attr("d","M 0 0 L 10 5 L 0 10 z"),ht(this.allzoomedelements,this.workflow,this.click_stage_callback,this.patch_data)},click_stage_callback(e,t){this.$emit("onclickstage",this.workflow.id,e,t)},clickDIV(){}},mounted(){const e=this,t={ok:function(o){e.workflow=o[e.workflow_id],e.initChart()},error:function(o){q.create({color:"bg-grey-2",message:"Unable to load workflow information",timeout:2e3,color:"negative"})}};k.workflow3(this.backend_connection_store,this.dataCachesStore,t)}});function vt(e,t,o,s,a,n){return c(),u("div",{id:"chartInsetionPoint_workflowchart",onClick:t[0]||(t[0]=r=>e.clickDIV(r))})}var jt=E(wt,[["render",vt]]);const Ct=B({name:"ToolsCansavePatchePage",components:{ProjectTable:_t,WrokflowChart:jt,TodoDisplay:he,ProjectData:Re},setup(){const e=Q(),t=L();return{backend_connection_store:e,dataCachesStore:t}},data(){return{workflows:void 0,loaded:!1,patch_data:{},tab:"projects",workflow_id:k.default_workflow_id,workflow_return_type:void 0}},computed:{featureflags(){return pe},buy_filtered_loaded_projects(){return this.$refs.BuyProjectData.filtered_loaded_projects},buy_cumulatively_loaded_stages(){return this.$refs.BuyProjectData.cumulatively_loaded_stages},buy_cumulatively_loaded_sources(){return this.$refs.BuyProjectData.cumulatively_loaded_sources},buy_cumulatively_loaded_agents(){return this.$refs.BuyProjectData.cumulatively_loaded_agents},rent_filtered_loaded_projects(){return this.$refs.RentProjectData.filtered_loaded_projects},rent_cumulatively_loaded_stages(){return this.$refs.RentProjectData.cumulatively_loaded_stages},rent_cumulatively_loaded_sources(){return this.$refs.RentProjectData.cumulatively_loaded_sources},rent_cumulatively_loaded_agents(){return this.$refs.RentProjectData.cumulatively_loaded_agents},user_profile(){return this.backend_connection_store.user_profile}},methods:{refresh_button(e){this.dataCachesStore.reset(),this.refresh()},buy_onRowClick({table_row:e,new_tab:t}){if(t){const o=this.$router.resolve("/tools/brrcalc"),s=new URL(o.href,window.location.origin+window.location.pathname).href+"?projectid="+e.id;window.open(s),window.focus();return}this.$router.push("/tools/brrcalc?projectid="+e.id)},rent_onRowClick({table_row:e,new_tab:t}){if(t){const o=this.$router.resolve("/tools/rentproject/rentcalc"),s=new URL(o.href,window.location.origin+window.location.pathname).href+"?projectid="+e.id;window.open(s),window.focus();return}this.$router.push("/tools/rentproject/rentcalc?projectid="+e.id)},btn_click_workflow(e){e==="rent"?this.workflow_id=k.default_rent_workflow_id:this.workflow_id=k.default_workflow_id,this.workflow_return_type=e,this.tab="workflow"},buy_projecttablefilterchanged(e){this.$refs.BuyProjectData.projecttablefilterchanged(e)},rent_projecttablefilterchanged(e){this.$refs.RentProjectData.projecttablefilterchanged(e)},onchartclickstage(e,t,o){const s=this;if(this.workflow_return_type==="rent"){this.tab="rent_projects",setTimeout(function(){const a=k.get_workflow_stage_key(e,t);s.$refs.RentProjectTableRef.set_selected_stages([a])},5);return}this.tab="projects",setTimeout(function(){const a=k.get_workflow_stage_key(e,t);s.$refs.BuyProjectTableRef.set_selected_stages([a])},5)},clicknewproject(){this.$router.push("/tools/brrcalc?patchid="+this.$route.params.patchid)},clickpatchagentnotes(){this.$router.push("/tools/agents/"+this.$route.params.patchid)},click_brrr_card(){this.$router.push("/tools/brrcalc")},refresh(){const e=this,t={ok:function(o){e.workflows=o,e.refresh_second()},error:function(o){q.create({color:"bg-grey-2",message:"Unable to load workflow information",timeout:2e3,color:"negative"})}};k.workflow3(this.backend_connection_store,this.dataCachesStore,t)},refresh_second(){const e=this,t={ok:e.refresh_success,error:function(o){q.create({color:"negative",message:"Failed to find patch information",timeout:2e3}),e.$router.push("/tools/cansave/patches")}};this.dataCachesStore.get({backend_connection_store:this.backend_connection_store,object_type:"patches",object_id:e.$route.params.patchid,skip_cache:!1,callback:t})},get_buy_current_project_filter(){if(typeof this.$refs.BuyProjectTableRef!="undefined"&&this.$refs.BuyProjectTableRef!==null)return this.$refs.BuyProjectTableRef.get_current_filter()},get_rent_current_project_filter(){if(typeof this.$refs.RentProjectTableRef!="undefined"&&this.$refs.RentProjectTableRef!==null)return this.$refs.RentProjectTableRef.get_current_filter()},refresh_success(e){const t=this;t.patch_data=e.data;var o=[],s=[];Object.keys(t.patch_data.workflow_lookup).map(function(a){Object.keys(t.patch_data.workflow_lookup[a]).map(function(n){t.patch_data.workflow_lookup[a][n].map(function(r){(function(f){return typeof t.patch_data.typed_projects.rent=="undefined"?!1:t.patch_data.typed_projects.rent.includes(f)})(r)?s.push({workflow_id:a,stage_id:n,project_id:r}):o.push({workflow_id:a,stage_id:n,project_id:r})})})}),this.$refs.BuyProjectData.refresh({project_info_to_load:o,patch_id:this.patch_data.id,get_cur_filter_fn:this.get_buy_current_project_filter,workflows:this.workflows}),this.$refs.RentProjectData.refresh({project_info_to_load:s,patch_id:this.patch_data.id,get_cur_filter_fn:this.get_rent_current_project_filter,workflows:this.workflows}),this.loaded=!0}},mounted(){this.loaded=!1,typeof this.$route.query.starttab!="undefined"&&(this.tab=this.$route.query.starttab),this.refresh()}}),$t={key:0},Tt=_("h1",null,"Loading...",-1),Pt=[Tt],Rt={key:1},St={key:0},Vt={key:2},Ft={class:"patch-button-bar"},Dt={key:3},Bt={class:"patch-button-bar"},Et={key:4},Qt={key:5};function At(e,t,o,s,a,n){const r=C("ProjectTable"),i=C("TodoDisplay"),f=C("WrokflowChart"),g=C("ProjectData");return c(),V(ie,{class:"patchpageclass"},{default:d(()=>[e.loaded?p("",!0):(c(),u("div",$t,Pt)),e.loaded?(c(),u("div",Rt,[e.tab!=="workflow"?(c(),u("h1",St,v(e.patch_data.name),1)):p("",!0),e.tab!=="workflow"?(c(),V(x,{key:1,modelValue:e.tab,"onUpdate:modelValue":t[0]||(t[0]=m=>e.tab=m),dense:"",class:"text-grey","active-color":"primary","indicator-color":"primary",align:"justify","narrow-indicator":""},{default:d(()=>[l(z,{name:"projects",label:"Buy Projects"}),e.featureflags.rent_to_rent_projects?(c(),V(z,{key:0,name:"rent_projects",label:"Rent Projects"})):p("",!0),l(z,{name:"todos",label:"Todos"})]),_:1},8,["modelValue"])):p("",!0),e.tab==="projects"?(c(),u("div",Vt,[_("h2",null,[y(" Buy Projects "),l(h,{label:"Pick from workflow",color:"primary",onClick:t[1]||(t[1]=m=>e.btn_click_workflow("purchase")),class:"float-right"})]),_("div",null,[l(r,{ref:"BuyProjectTableRef",projects:e.buy_filtered_loaded_projects,prefiltered:!0,cumulatively_loaded_stages:e.buy_cumulatively_loaded_stages,cumulatively_loaded_agents:e.buy_cumulatively_loaded_agents,cumulatively_loaded_sources:e.buy_cumulatively_loaded_sources,onFilterchanged:e.buy_projecttablefilterchanged,onOnRowClick:e.buy_onRowClick,onRefresh_button:t[2]||(t[2]=m=>e.refresh_button("purchase"))},null,8,["projects","cumulatively_loaded_stages","cumulatively_loaded_agents","cumulatively_loaded_sources","onFilterchanged","onOnRowClick"])]),_("div",Ft,[l(h,{color:"primary",label:"Add Project",icon:"add",onClick:e.clicknewproject},null,8,["onClick"]),l(h,{color:"primary",label:"Patch Agent Notes",icon:"edit",onClick:e.clickpatchagentnotes},null,8,["onClick"])])])):p("",!0),e.tab==="rent_projects"?(c(),u("div",Dt,[_("h2",null,[y(" Rent Projects "),l(h,{label:"Pick from workflow",color:"primary",onClick:t[3]||(t[3]=m=>e.btn_click_workflow("rent")),class:"float-right"})]),_("div",null,[l(r,{ref:"RentProjectTableRef",projects:e.rent_filtered_loaded_projects,prefiltered:!0,cumulatively_loaded_stages:e.rent_cumulatively_loaded_stages,cumulatively_loaded_agents:e.rent_cumulatively_loaded_agents,cumulatively_loaded_sources:e.rent_cumulatively_loaded_sources,onFilterchanged:e.rent_projecttablefilterchanged,onOnRowClick:e.rent_onRowClick,onRefresh_button:t[4]||(t[4]=m=>e.refresh_button("rent"))},null,8,["projects","cumulatively_loaded_stages","cumulatively_loaded_agents","cumulatively_loaded_sources","onFilterchanged","onOnRowClick"]),_("div",Bt,[l(h,{color:"primary",label:"Add Lead",onClick:t[5]||(t[5]=m=>e.$router.push("/tools/rentproject/enterlead?defaultpatch="+e.patch_data.id))}),l(h,{color:"primary",label:"Call Leads",onClick:t[6]||(t[6]=m=>e.$router.push("/tools/rentproject/batchcallleads?patchid="+e.patch_data.id))}),l(h,{color:"primary",label:"Show Viewings",onClick:t[7]||(t[7]=m=>e.$router.push("/tools/rentproject/showviewingsforpatch?patchid="+e.patch_data.id))})])])])):p("",!0),e.tab==="todos"?(c(),u("div",Et,[l(i,{patch_id:e.patch_data.id},null,8,["patch_id"])])):p("",!0),e.tab==="workflow"?(c(),u("div",Qt,[l(f,{patch_data:e.patch_data,workflow_id:e.workflow_id,onOnclickstage:e.onchartclickstage},null,8,["patch_data","workflow_id","onOnclickstage"])])):p("",!0)])):p("",!0),l(g,{ref:"BuyProjectData",project_type:"purchase"},null,512),l(g,{ref:"RentProjectData",project_type:"rent"},null,512)]),_:1})}var co=E(Ct,[["render",At]]);export{co as default};
