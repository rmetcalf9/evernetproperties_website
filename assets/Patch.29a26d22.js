import{d as P,_ as S,r as C,o as s,K as i,e as k,a as u,w as p,aq as d,t as m,L as B,M as I,ad as L,a7 as N,f as $,N as V,c as W,ae as x}from"./index.dc27f786.js";import{Q}from"./QPage.0f9539d3.js";import{u as j}from"./backend_connection.d35c9bbf.js";import{b as w,Q as E}from"./QTable.1b42459e.js";import{C as A}from"./CommonBRRToolLink.3b06531d.js";import{W as v}from"./Workflow_main.1f15d70b.js";import{c as D,z as q}from"./zoom.2619b28f.js";import"./axios.6e1fcf85.js";import"./QItemLabel.c7618e21.js";import"./position-engine.6694cd95.js";const U=P({name:"ToolsCansavePatchePage",props:["projects","prefiltered"],components:{CommonBRRToolLink:A},setup(){return{backend_connection_store:j()}},data(){return{filter:"",columns:[{name:"address",required:!0,label:"Address",align:"left",field:"address",sortable:!0},{name:"workflowstage",required:!0,label:"Stage",align:"left",field:"address",sortable:!0},{name:"visionandnotes",required:!0,label:"Vision and Notes",align:"left",field:"address",sortable:!0},{name:"source",required:!0,label:"Source",align:"left",field:"address",sortable:!0}],initialPagination:{rowsPerPage:50}}},computed:{user_profile(){return this.backend_connection_store.user_profile}},methods:{get_source_text(e){return typeof e.item.sub_section_details.dealbasicinfo.deal_source=="undefined"||e.item.sub_section_details.dealbasicinfo.deal_source.type==="self"?"Self":e.item.sub_section_details.dealbasicinfo.deal_source.value},getWorkflowStage({workflow_used_id:e,current_stage:t}){return v.workflows[e].stages[t]},onRowClick(e){this.$router.push("/tools/brrcalc?projectid="+e.id)}},mounted(){}}),F={class:"projecttablecontainer"},G={class:"projecttablestyle"},M={key:0},H={key:1},K={key:0},X={key:0},Y={key:0},J={class:"projecttablehead"},Z={key:0},O={key:0},ee={key:0},te={key:0},oe={key:1},re={key:1};function ae(e,t,a,o,n,l){const c=C("CommonBRRToolLink");return s(),i("div",F,[k("div",G,[u(E,{flat:"",bordered:"",title:"Projects",rows:e.projects,columns:e.columns,filter:e.filter,pagination:e.initialPagination,"no-data-label":"I didn't find anything for you","no-results-label":"The filter didn't uncover any results","row-key":"name"},{"body-cell-address":p(r=>[u(w,{onClick:f=>e.onRowClick(r.row)},{default:p(()=>[r.row.loaded?d("",!0):(s(),i("div",M," Loading... ")),r.row.loaded?(s(),i("div",H,m(r.row.item.sub_section_details.dealbasicinfo.address),1)):d("",!0)]),_:2},1032,["onClick"])]),"body-cell-workflowstage":p(r=>[u(w,{onClick:f=>e.onRowClick(r.row)},{default:p(()=>[r.row.loaded?(s(),i("div",K,[typeof r.row.item.workflow!="undefined"?(s(),i("div",X,m(e.getWorkflowStage(r.row.item.workflow).name),1)):d("",!0)])):d("",!0)]),_:2},1032,["onClick"])]),"body-cell-visionandnotes":p(r=>[u(w,{onClick:f=>e.onRowClick(r.row)},{default:p(()=>[r.row.loaded?(s(),i("div",Y,[k("div",J,m(r.row.item.sub_section_details.vision.devplan),1),typeof r.row.item.sub_section_details.dealbasicinfo.notes!="undefined"?(s(),i("div",Z,[(s(!0),i(B,null,I(r.row.item.sub_section_details.dealbasicinfo.notes.split(`
`),f=>(s(),i("div",{key:f},m(f),1))),128))])):d("",!0)])):d("",!0)]),_:2},1032,["onClick"])]),"body-cell-source":p(r=>[u(w,{onClick:f=>e.onRowClick(r.row)},{default:p(()=>[r.row.loaded?(s(),i("div",O,[k("div",null,m(e.get_source_text(r.row)),1)])):d("",!0)]),_:2},1032,["onClick"])]),"top-right":p(()=>[u(L,{borderless:"",dense:"",debounce:"300",modelValue:e.filter,"onUpdate:modelValue":t[0]||(t[0]=r=>e.filter=r),clearable:"",placeholder:"Search"},{append:p(()=>[u(N,{name:"search"})]),_:1},8,["modelValue"])]),"no-data":p(({})=>[e.prefiltered?d("",!0):(s(),i("div",ee,[e.projects.length===0?(s(),i("div",te,[$(" No projects in this patch - use the BRR calculator to create one "),u(c)])):d("",!0),e.projects.length!==0?(s(),i("div",oe," No projects match the filter ")):d("",!0)])),e.prefiltered?(s(),i("div",re," No projects match the filter ")):d("",!0)]),_:1},8,["rows","columns","filter","pagination"])])])}var ne=S(U,[["render",ae]]);function se(e,t,a,o){const n={items_drawn:{},cols:[-300,120,560]};T(e,t.initial_stage,t.stages[t.initial_stage],n,t,200,!1,a,o)}const y=130,b=400;function ie(e,t,a){let o=0;return a?o=2:typeof e.draw_col!="undefined"&&(o=e.draw_col),t.cols[o]}function T(e,t,a,o,n,l,c,r,f){if(Object.keys(o.items_drawn).includes(t))return;const _=ie(a,o,c),g=e.append("g").attr("transform","translate( "+_+" "+l+")");o.items_drawn[t]={pos_x:_,pos_y:l},le(g,t,a,c,r,n,f),typeof a.progression!="undefined"&&(typeof a.progression.failed!="undefined"&&(T(e,a.progression.failed,n.stages[a.progression.failed],o,n,l+150,!0,r,f),z(e,_,l+y,o.cols[2]-b/2,l+150+y/2)),typeof a.progression.success!="undefined"&&a.progression.success.forEach(function(h){T(e,h.next_stage,n.stages[h.next_stage],o,n,l+300,!1,r,f),z(e,_,l+y,o.items_drawn[h.next_stage].pos_x,o.items_drawn[h.next_stage].pos_y)}))}function z(e,t,a,o,n){e.append("line").attr("x1",t).attr("y1",a).attr("x2",o).attr("y2",n).attr("stroke","black").attr("style","stroke-width:10;").attr("marker-end","url(#triangle)")}function le(e,t,a,o,n,l,c){const r=e.append("g");let f="lightgreen";o&&(f="pink");function _(){n(t,a)}let g=0;if(typeof c.workflow_lookup!="undefined"&&typeof c.workflow_lookup[l.id]!="undefined"&&typeof c.workflow_lookup[l.id][t]!="undefined"&&(g=c.workflow_lookup[l.id][t].length),r.append("rect").attr("width",b).attr("height",y).attr("x",-(b/2)).attr("y",0).attr("style","fill: "+f+";stroke-width:3;stroke:rgb(0,0,0)").on("click",_),r.append("text").attr("x",0).attr("y",50).attr("text-anchor","middle").style("font-size","28px").style("font-weight","500").text(a.name).on("click",_),r.append("text").attr("x",0).attr("y",110).attr("text-anchor","middle").style("font-size","56px").style("font-weight","500").text(g.toString()).on("click",_),typeof a.diagram_notes!="undefined"){let h=0;a.diagram_notes.split("<BR>").forEach(function(R){r.append("text").attr("x",-(b/2+20)).attr("y",h).attr("text-anchor","end").attr("alignment-baseline","text-before-edge").style("font-size","24px").style("font-weight","500").text(R),h=h+30})}}const de=P({name:"WorkflowChart",props:["patch_data"],emits:["onclickstage"],data(){return{allzoomedelements:void 0,boudaryRect:void 0,svg:void 0,background_item_group:void 0,chartarea:{xmin:-950,xmax:950,ymin:-150,ymax:2300}}},computed:{workflow(){return v.workflows[v.default_workflow_id]}},methods:{initChart(){for(var e=this,t=function(o){var n=800,l=800;o.svg=D("svg").attr("style","border: 1px solid black;position:fixed; top:0; left:0; height:100%; width:100%").attr("viewBox",[-n/2,-l/2,n,l]).attr("oncontextmenu","return false;"),o.allzoomedelements=o.svg.append("g"),e.boudaryRect=o.allzoomedelements.append("rect").attr("width",o.chartarea.xmax-o.chartarea.xmin).attr("height",o.chartarea.ymax-o.chartarea.ymin).attr("x",o.chartarea.xmin).attr("y",o.chartarea.ymin).attr("style","fill: white;stroke-width:3;stroke:rgb(0,0,0)"),o.svg.call(q().extent([[0,0],[n,l]]).scaleExtent([-5,10]).on("zoom",c)),o.svg.on("dblclick.zoom",null);function c(r,f){o.allzoomedelements.attr("transform",r.transform)}return o.allzoomedelements.append("text").attr("text-anchor","middle").attr("alignment-baseline","central").attr("x",0).attr("y",-70).attr("style","font-size: 60px; font-weight: 800;").text(r=>e.workflow.name),o.allzoomedelements.append("text").attr("text-anchor","middle").attr("alignment-baseline","central").attr("x",0).attr("y",-0).attr("style","font-size: 50px; font-weight: 300;").text(r=>"Projects for patch "+e.patch_data.name),o.allzoomedelements.append("text").attr("text-anchor","middle").attr("alignment-baseline","central").attr("x",0).attr("y",60).attr("style","font-size: 40px; font-weight: 300;").text(r=>"(Note: Diagram only - workflows not yet implemented)"),o.svg.node()},a=document.getElementById("chartInsetionPoint_workflowchart");a.firstChild;)console.log("Removing old SVG"),a.removeChild(a.firstChild);a.appendChild(t(this)),this.svg.append("marker").attr("id","triangle").attr("viewBox","0 0 10 10").attr("refX","8").attr("refY","5").attr("markerUnits","strokeWidth").attr("markerWidth","4").attr("markerHeight","4").attr("orient","auto").attr("fill","black").append("path").attr("d","M 0 0 L 10 5 L 0 10 z"),se(this.allzoomedelements,this.workflow,this.click_stage_callback,this.patch_data)},click_stage_callback(e,t){this.$emit("onclickstage",this.workflow.id,e,t)},clickDIV(){}},mounted(){this.initChart()}});function ce(e,t,a,o,n,l){return s(),i("div",{id:"chartInsetionPoint_workflowchart",onClick:t[0]||(t[0]=c=>e.clickDIV(c))})}var fe=S(de,[["render",ce]]);const ue=P({name:"ToolsCansavePatchePage",components:{ProjectTable:ne,WrokflowChart:fe},setup(){return{backend_connection_store:j()}},data(){return{loaded:!1,patch_data:{},loaded_projects:[],filtered_loaded_projects:[],selected_stage:{workflow_id:void 0,stage_id:void 0},table_view:!0}},watch:{loaded_projects(e){this.recompute_filtered_projects()}},computed:{isStageSelected(){return typeof this.selected_stage.workflow_id!="undefined"},selectedStageText(){return v.workflows[this.selected_stage.workflow_id].stages[this.selected_stage.stage_id].name},user_profile(){return this.backend_connection_store.user_profile}},methods:{recompute_filtered_projects(){const e=this;this.filtered_loaded_projects=this.loaded_projects.filter(function(t){return e.isStageSelected?typeof e.patch_data.workflow_lookup[e.selected_stage.workflow_id]=="undefined"||typeof e.patch_data.workflow_lookup[e.selected_stage.workflow_id][e.selected_stage.stage_id]=="undefined"?!1:e.patch_data.workflow_lookup[e.selected_stage.workflow_id][e.selected_stage.stage_id].filter(function(a){return t.id===a}).length>0:!0})},clearselectesstage(){this.selected_stage={workflow_id:void 0,stage_id:void 0},this.recompute_filtered_projects()},onchartclickstage(e,t,a){this.selected_stage={workflow_id:e,stage_id:t},this.recompute_filtered_projects(),this.table_view=!0},clicknewproject(){this.$router.push("/tools/brrcalc?patchid="+this.$route.params.patchid)},click_brrr_card(){this.$router.push("/tools/brrcalc")},refresh(){const e=this,t={ok:e.refresh_success,error:function(a){V.create({color:"negative",message:"Failed to find patch information",timeout:2e3}),e.$router.push("/tools/cansave/patches")}};this.backend_connection_store.call_api({apiprefix:"privateUserAPIPrefix",url:"/patches/"+e.$route.params.patchid,method:"GET",data:void 0,callback:t})},refresh_success(e){this.patch_data=e.data,this.loaded_projects=this.patch_data.projects.map(function(t){return{id:t,loaded:!1,item:void 0}}),this.recursive_load_project_details(),this.loaded=!0},recursive_load_project_details(){const e=this.loaded_projects.filter(function(n){return n.loaded===!1});if(e.length===0)return;const t=e[0],a=this,o={ok:function(n){t.loaded=!0,t.item=n.data,a.recompute_filtered_projects(),a.recursive_load_project_details()},error:function(n){t.loaded=!0,t.address="TODO LOAD FAIL",a.recursive_load_project_details()}};this.backend_connection_store.call_api({apiprefix:"privateUserAPIPrefix",url:"/projects/"+t.id,method:"GET",data:void 0,callback:o})}},mounted(){this.loaded=!1,this.refresh()}}),pe={key:0},_e=k("h1",null,"Loading...",-1),he=[_e],me={key:1},ke={key:0},ge={key:0,class:"selected_stage"},we={key:1};function ye(e,t,a,o,n,l){const c=C("ProjectTable"),r=C("WrokflowChart");return s(),W(Q,{class:"patchpageclass"},{default:p(()=>[e.loaded?d("",!0):(s(),i("div",pe,he)),e.loaded?(s(),i("div",me,[e.table_view?(s(),i("div",ke,[k("h1",null,m(e.patch_data.name),1),k("h2",null,[$("Projects "),u(x,{color:"primary",icon:"account_tree",label:"Worlflow",onClick:t[0]||(t[0]=f=>e.table_view=!1)})]),e.isStageSelected?(s(),i("div",ge,[$(" Stage "+m(e.selectedStageText)+" ",1),u(x,{color:"primary",icon:"close",round:"",onClick:e.clearselectesstage},null,8,["onClick"])])):d("",!0),k("div",null,[u(c,{projects:e.filtered_loaded_projects,prefiltered:e.isStageSelected},null,8,["projects","prefiltered"])]),u(x,{color:"primary",label:"Add Project",onClick:e.clicknewproject},null,8,["onClick"])])):d("",!0),e.table_view?d("",!0):(s(),i("div",we,[u(r,{patch_data:e.patch_data,onOnclickstage:e.onchartclickstage},null,8,["patch_data","onOnclickstage"])]))])):d("",!0)]),_:1})}var Re=S(ue,[["render",ye]]);export{Re as default};
